<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PRL Assist - Simple Plugin Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            min-height: 100vh;
            color: #2c3e50;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: white; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05); 
        }
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.05); 
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            font-size: 14px;
            background: white;
            color: #2c3e50;
        }
        input::placeholder, textarea::placeholder {
            color: #6c757d;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #E67E22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }
        .btn { 
            background: #E67E22; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn:hover { 
            background: #D35400;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .code-block { 
            background: rgba(0,0,0,0.4); 
            color: #E8F4F8; 
            padding: 20px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            overflow-x: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .success { 
            background: rgba(46, 204, 113, 0.2); 
            border: 1px solid #2ecc71; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
        }
        .warning { 
            background: rgba(241, 196, 15, 0.2); 
            border: 1px solid #f1c40f; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
        }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { 
            padding: 12px 24px; 
            background: white; 
            border: 1px solid #e9ecef; 
            cursor: pointer; 
            border-radius: 8px 8px 0 0; 
            margin-right: 2px;
            color: #2c3e50;
            font-weight: 500;
        }
        .tab.active { 
            background: #E67E22; 
            color: white;
            border-color: #E67E22; 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .preview-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 68px;
            height: 68px;
            background: #E67E22;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.2s ease;
        }
        .preview-widget:hover {
            transform: scale(1.1);
        }
        .preview-widget img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ AI PRL Assist - Simple Plugin Control Panel</h1>
            <p>Configure your chat widget with simple, powerful parameters</p>
            
            <!-- CLIENT SELECTOR -->
            <div class="form-group" style="margin-top: 20px;">
                <label for="clientSelector">üìã Select Existing Client:</label>
                <select id="clientSelector" onchange="loadSelectedClient()">
                    <option value="">-- Select a client to load --</option>
                </select>
                <button type="button" class="btn" onclick="refreshClientList()" style="margin-top: 10px; background: #28a745;">
                    üîÑ Refresh Client List
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
            <button class="tab" onclick="showTab('code')">üìã Client Code</button>
            <button class="tab" onclick="showTab('utm')">üéØ UTM Flow</button>
        </div>

        <div id="config" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>üé® Widget Appearance</h3>
                    <div class="form-group">
                        <label>Site ID (Unique Client Identifier)</label>
                        <input type="text" id="siteId" value="aiprlassist-default" placeholder="e.g., cliente-orange-001">
                    </div>
                    <div class="form-group">
                        <label>Client Name</label>
                        <input type="text" id="clientName" value="AI PRL Assist (Default)" placeholder="Client display name">
                    </div>
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="text" id="chatId" value="O1T4KXJ9xZ" placeholder="Your chat ID">
                    </div>
                    <div class="form-group">
                        <label>Account ID</label>
                        <input type="text" id="accountId" value="1047143" placeholder="Your account ID">
                    </div>
                    <div class="form-group">
                        <label>Bubble Color</label>
                        <input type="color" id="color" value="#E67E22">
                    </div>
                    <div class="form-group">
                        <label>Text Color</label>
                        <input type="color" id="textColor" value="#ffffff">
                    </div>
                    <div class="form-group">
                        <label>Outline Color</label>
                        <input type="color" id="outlineColor" value="#3498DB">
                    </div>
                    <div class="form-group">
                        <label>Icon URL</label>
                        <input type="url" id="icon" value="https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png">
                    </div>
                    <div class="form-group">
                        <label>Bubble Label/Message</label>
                        <input type="text" id="bubbleLabel" value="Hi! Need help?" placeholder="Message shown on bubble">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="position">
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-left">Bottom Left</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Size (px)</label>
                        <input type="number" id="size" value="68" min="40" max="100">
                    </div>
                    <div class="form-group">
                        <label>Z-Index</label>
                        <input type="number" id="zIndex" value="2147483000" min="1000" max="2147483647">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="pulse" checked> Pulse Animation
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>‚è∞ Triggers & Timing</h3>
                    <div class="form-group">
                        <label>Show Bubble After (ms)</label>
                        <input type="number" id="showBubbleAfterMs" value="3000" min="0" max="60000">
                    </div>
                    <div class="form-group">
                        <label>Auto-Open After (ms) - 0 = disabled</label>
                        <input type="number" id="openAfterMs" value="0" min="0" max="300000">
                    </div>
                    <div class="form-group">
                        <label>Scroll Trigger (%) - 0 = disabled</label>
                        <input type="number" id="scrollTrigger" value="0" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="exitIntent"> Exit Intent Trigger
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üì± Display Rules</h3>
                    <div class="form-group">
                        <label>Include Paths (one per line, * = all)</label>
                        <textarea id="includePaths" rows="3">*</textarea>
                    </div>
                    <div class="form-group">
                        <label>Exclude Paths (one per line)</label>
                        <textarea id="excludePaths" rows="3" placeholder="/admin/*&#10;/checkout/*"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOnMobile" checked> Show on Mobile
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOnDesktop" checked> Show on Desktop
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="appendUTM" checked> Capture UTM Parameters
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üí¨ Teaser Messages</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="teaserEnabled" checked> Enable Teaser Messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Teaser Text</label>
                        <input type="text" id="teaserText" value="üëã Hi! I'm here to help with your retail experience. Got questions?" placeholder="Teaser message text">
                    </div>
                    <div class="form-group">
                        <label>Show Teaser After (ms)</label>
                        <input type="number" id="teaserDelay" value="5000" min="1000" max="30000">
                    </div>
                    <div class="form-group">
                        <label>Auto-close Teaser After (ms)</label>
                        <input type="number" id="teaserAutoclose" value="15000" min="5000" max="60000">
                    </div>
                </div>

                <div class="card">
                    <h3>üéõÔ∏è Advanced Rules</h3>
                    <div class="form-group">
                        <label>Min Screen Width (px)</label>
                        <input type="number" id="minWidth" value="0" min="0" max="2000">
                    </div>
                    <div class="form-group">
                        <label>Max Screen Width (px)</label>
                        <input type="number" id="maxWidth" value="99999" min="320" max="99999">
                    </div>
                    <div class="form-group">
                        <label>Frequency Cap (hours) - 0 = no limit</label>
                        <input type="number" id="frequencyCap" value="24" min="0" max="168">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="trackOpens" checked> Track Chat Opens
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üñºÔ∏è Chat Window</h3>
                    <div class="form-group">
                        <label>Window Mode</label>
                        <select id="windowMode">
                            <option value="windowed">Windowed (Desktop)</option>
                            <option value="fullscreen">Fullscreen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Window Width (px)</label>
                        <input type="number" id="windowWidth" value="420" min="300" max="800">
                    </div>
                    <div class="form-group">
                        <label>Window Height (px)</label>
                        <input type="number" id="windowHeight" value="650" min="400" max="900">
                    </div>
                    <div class="form-group">
                        <label>Overlay Background</label>
                        <input type="text" id="overlayBg" value="rgba(0,0,0,0.45)" placeholder="rgba(0,0,0,0.45)">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="closeOnEsc" checked> Close on ESC key
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Fallback URL (if main chat fails)</label>
                        <input type="url" id="fallbackUrl" value="https://app.aiprlassist.com/webchat/?p=1047143&ref=1746442093403">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="noOverlay"> No Dark Overlay (transparent background)
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üî• Live Preview</h3>
                    <p>Changes reflect instantly below:</p>
                    <div id="livePreview" style="margin-top: 20px; text-align: center;">
                        <div class="preview-widget" id="previewWidget">
                            <img id="previewIcon" src="https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png" alt="Chat">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <button class="btn" onclick="saveToDatabase()" style="background: #28a745; font-size: 18px; padding: 15px 30px;">üíæ SAVE TO DATABASE</button>
                <button class="btn" onclick="updatePreview()">üîÑ Update Preview</button>
                <button class="btn" onclick="testWidget()">üß™ Test Widget</button>
            </div>
        </div>

        <div id="code" class="tab-content">
            <div class="card">
                <h3>üìã Client Code (Copy & Paste)</h3>
                <div class="success">
                    ‚úÖ <strong>Simple and powerful!</strong> Just two script tags.
                </div>
                <div class="code-block" id="clientCode">
&lt;!-- AI PRL Assist Chat Widget (Remote Config Enabled) --&gt;
&lt;script src="https://dynamiccode-ochre.vercel.app/plugin.js"&gt;&lt;/script&gt;
&lt;script&gt;
ChatWidget.setup({
  siteId: "aiprlassist-default", // Remote config enabled!
  id: "O1T4KXJ9xZ",
  accountId: "1047143",
  color: "#E67E22",
  position: "bottom-right",
  size: 68,
  showDelay: 3000,
  utmCapture: true,
  analytics: true,
  noOverlay: false
});
&lt;/script&gt;
                </div>
                
                <div class="success">
                    <strong>üöÄ NEW 2024 APPROACH - RESEARCH BASED!</strong><br>
                    ‚úÖ Intercom/Rasa style embedding<br>
                    ‚úÖ Shadow DOM isolation<br>
                    ‚úÖ Async loading (GHL compatible)<br>
                    ‚úÖ Automatic UTM capture<br>
                    ‚úÖ Works on ALL platforms
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è GoHighLevel Instructions:</strong><br>
                    <strong>Method 1 (Recommended):</strong><br>
                    1. Go to <strong>Sites ‚Üí [Your Site] ‚Üí Settings ‚Üí Tracking Code</strong><br>
                    2. Paste the code above in <strong>"Footer Tracking Code"</strong><br>
                    3. Click <strong>Save</strong> and <strong>Publish Site</strong><br>
                    4. Widget appears on all pages automatically<br><br>
                    
                    <strong>Method 2 (If Method 1 fails):</strong><br>
                    1. Go to <strong>Sites ‚Üí [Your Site] ‚Üí Pages</strong><br>
                    2. Edit any page ‚Üí <strong>Settings</strong> (gear icon)<br>
                    3. Scroll to <strong>"Custom Code"</strong> section<br>
                    4. Paste in <strong>"Footer Code"</strong> field<br>
                    5. Save and publish
                </div>
                
                <div class="warning">
                    <strong>üåê Other Platforms (All Compatible):</strong><br>
                    <strong>Webflow:</strong> Project Settings ‚Üí Custom Code ‚Üí Footer Code<br>
                    <strong>WordPress:</strong> Appearance ‚Üí Theme Editor ‚Üí footer.php (before &lt;/body&gt;)<br>
                    <strong>Shopify:</strong> Online Store ‚Üí Themes ‚Üí Edit Code ‚Üí theme.liquid (before &lt;/body&gt;)<br>
                    <strong>Squarespace:</strong> Settings ‚Üí Advanced ‚Üí Code Injection ‚Üí Footer<br>
                    <strong>Wix:</strong> ‚ùå Not supported (Wix blocks external scripts)<br><br>
                    
                    <strong>üí° Pro Tip:</strong> The <code>async</code> attribute ensures the widget doesn't block page loading!
                </div>
            </div>
        </div>

        <div id="utm" class="tab-content">
            <div class="card">
                <h3>üéØ UTM Parameter Flow - Complete End-to-End</h3>
                
                <h4>üì• 1. UTM Capture (Automatic)</h4>
                <p>When someone visits your client's site with UTM parameters:</p>
                <div class="code-block">
https://client-site.com/page?utm_source=facebook&utm_medium=cpc&utm_campaign=promo2024&utm_term=shoes&utm_content=ad1
                </div>
                
                <h4>üîÑ 2. Parameter Processing (plugin.js)</h4>
                <p>The widget automatically captures these parameters from the URL:</p>
                <div class="code-block">
const currentParams = new URLSearchParams(location.search);
['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
  const value = currentParams.get(param);
  if (value) url.searchParams.set(param, value);
});
                </div>
                
                <h4>üì§ 3. Parameter Forwarding</h4>
                <p>When chat opens, ALL parameters are passed to your chat URL:</p>
                <div class="code-block">
https://app.aiprlassist.com/webchat/?p=1047143&id=O1T4KXJ9xZ&embed=1&host=client-site.com&page=https://client-site.com/page&utm_source=facebook&utm_medium=cpc&utm_campaign=promo2024&utm_term=shoes&utm_content=ad1
                </div>
                
                <h4>üí¨ 4. Chat System Access</h4>
                <p>Your chat system receives ALL this data and can:</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>‚úÖ Track which campaign brought the visitor</li>
                    <li>‚úÖ Personalize responses based on source</li>
                    <li>‚úÖ Attribute conversions to specific ads</li>
                    <li>‚úÖ Build detailed analytics reports</li>
                </ul>
                
                <h4>üìä 5. Additional Context</h4>
                <p>Plus automatic page context:</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><code>host</code> - Which domain (client-site.com)</li>
                    <li><code>page</code> - Exact page URL</li>
                    <li><code>ref</code> - Where they came from (if available)</li>
                    <li><code>embed=1</code> - Identifies widget traffic</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function updatePreview() {
            const color = document.getElementById('color').value;
            const icon = document.getElementById('icon').value;
            const size = document.getElementById('size').value;
            
            const previewWidget = document.getElementById('previewWidget');
            const previewIcon = document.getElementById('previewIcon');
            
            previewWidget.style.background = color;
            previewWidget.style.width = size + 'px';
            previewWidget.style.height = size + 'px';
            previewIcon.src = icon;
            
            updateClientCode();
        }

        async function saveToDatabase() {
            console.log('üî¥ DEBUG: saveToDatabase() called');
            
            const siteId = document.getElementById('siteId').value || "aiprlassist-default";
            console.log('üî¥ DEBUG: siteId to save:', siteId);
            
            // Visual feedback - make save button red while saving
            const saveBtn = document.querySelector('button[onclick="saveToDatabase()"]');
            if (saveBtn) {
                saveBtn.style.backgroundColor = '#ff5722';
                saveBtn.innerHTML = 'üíæ Saving...';
            }
            
            const config = {
                chatUrl: "https://app.aiprlassist.com/webchat/?p=" + document.getElementById('accountId').value + "&id=" + document.getElementById('chatId').value,
                fallbackUrl: document.getElementById('fallbackUrl').value,
                bubble: {
                    position: document.getElementById('position').value === 'bottom-left' ? 'bl' : 'br',
                    size: parseInt(document.getElementById('size').value),
                    bg: document.getElementById('color').value,
                    color: document.getElementById('textColor').value,
                    outline: document.getElementById('outlineColor').value,
                    label: document.getElementById('bubbleLabel').value,
                    iconUrl: document.getElementById('icon').value,
                    pulse: document.getElementById('pulse').checked,
                    zIndex: parseInt(document.getElementById('zIndex').value)
                },
                teaser: {
                    enabled: document.getElementById('teaserEnabled').checked,
                    text: document.getElementById('teaserText').value,
                    delayMs: parseInt(document.getElementById('teaserDelay').value),
                    autocloseMs: parseInt(document.getElementById('teaserAutoclose').value)
                },
                triggers: {
                    showBubbleAfterMs: parseInt(document.getElementById('showBubbleAfterMs').value),
                    openAfterMs: parseInt(document.getElementById('openAfterMs').value),
                    triggerOnScrollPercent: parseInt(document.getElementById('scrollTrigger').value),
                    triggerOnExitIntent: document.getElementById('exitIntent').checked
                },
                rules: {
                    includePaths: document.getElementById('includePaths').value.split('\n').filter(p => p.trim()),
                    excludePaths: document.getElementById('excludePaths').value.split('\n').filter(p => p.trim()),
                    showOnMobile: document.getElementById('showOnMobile').checked,
                    showOnDesktop: document.getElementById('showOnDesktop').checked,
                    minWidth: parseInt(document.getElementById('minWidth').value),
                    maxWidth: parseInt(document.getElementById('maxWidth').value),
                    frequencyCapHours: parseInt(document.getElementById('frequencyCap').value),
                    appendUTM: document.getElementById('appendUTM').checked
                },
                overlay: {
                    bg: document.getElementById('overlayBg').value,
                    closeOnEsc: document.getElementById('closeOnEsc').checked,
                    windowMode: document.getElementById('windowMode').value === 'windowed',
                    windowWidth: document.getElementById('windowWidth').value + "px",
                    windowHeight: document.getElementById('windowHeight').value + "px"
                },
                analytics: {
                    console: true,
                    trackOpens: document.getElementById('trackOpens').checked
                },
                noOverlay: document.getElementById('noOverlay').checked
            };
            
            try {
                console.log('üî¥ DEBUG: About to send config to API:', config);
                
                const response = await fetch('/api/save-config-real', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        siteId: siteId,
                        clientName: document.getElementById('clientName').value || "AI PRL Assist (Default)",
                        config: config
                    })
                });
                
                console.log('üî¥ DEBUG: Response status:', response.status);
                const result = await response.json();
                console.log('üî¥ DEBUG: Response data:', result);
                
                if (response.ok && result.success) {
                    console.log('‚úÖ SAVED TO DATABASE SUCCESSFULLY!');
                    
                    // Visual feedback - make save button green on success
                    if (saveBtn) {
                        saveBtn.style.backgroundColor = '#4caf50';
                        saveBtn.innerHTML = '‚úÖ SAVED!';
                        setTimeout(() => {
                            saveBtn.style.backgroundColor = '#28a745';
                            saveBtn.innerHTML = 'üíæ Save to Database';
                        }, 2000);
                    }
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.innerHTML = '‚úÖ SAVED TO DATABASE!<br>Configuration updated in Postgres.';
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4caf50;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    `;
                    document.body.appendChild(successDiv);
                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 3000);
                    
                    updateClientCode();
                } else {
                    console.error('‚ùå SAVE FAILED:', result.error);
                    
                    // Visual feedback - make save button red on error
                    if (saveBtn) {
                        saveBtn.style.backgroundColor = '#f44336';
                        saveBtn.innerHTML = '‚ùå SAVE FAILED';
                    }
                    
                    alert(`‚ùå SAVE FAILED: ${result.error}`);
                }
            } catch (error) {
                console.error('‚ùå ERROR SAVING:', error);
                
                // Visual feedback - make save button red on error
                if (saveBtn) {
                    saveBtn.style.backgroundColor = '#f44336';
                    saveBtn.innerHTML = '‚ùå ERROR';
                }
                
                alert(`‚ùå ERROR: ${error.message}`);
            }
        }

        function updateClientCode() {
            const siteId = document.getElementById('siteId').value || "aiprlassist-default";
            const chatId = document.getElementById('chatId').value || siteId;
            const accountId = document.getElementById('accountId').value || "1047143";
            
            const code = `&lt;!-- AI PRL Assist Chat Widget (Remote Config Enabled) --&gt;
&lt;script src="https://dynamiccode-ochre.vercel.app/plugin.js"&gt;&lt;/script&gt;
&lt;script&gt;
ChatWidget.setup({
  siteId: "${siteId}",
  id: "${chatId}",
  accountId: "${accountId}"
});
&lt;/script&gt;`;
            
            document.getElementById('clientCode').innerHTML = code;
        }

        function testWidget() {
            // Remove existing test widget
            const existing = document.getElementById('testWidget');
            if (existing) existing.remove();
            
            // Create test script
            const script = document.createElement('script');
            script.innerHTML = `
                if (window.ChatWidget && window.ChatWidget.setup) {
                    ChatWidget.setup({
                        id: "${document.getElementById('chatId').value}",
                        accountId: "${document.getElementById('accountId').value}",
                        color: "${document.getElementById('color').value}",
                        icon: "${document.getElementById('icon').value}",
                        position: "${document.getElementById('position').value}",
                        size: ${document.getElementById('size').value}
                    });
                }
            `;
            script.id = 'testWidget';
            document.body.appendChild(script);
            
            alert('üß™ Test widget loaded! Check bottom-right corner.');
        }

        // Load list of all clients
        async function refreshClientList() {
            console.log('üî¥ DEBUG: refreshClientList() called');
            
            const selector = document.getElementById('clientSelector');
            console.log('üî¥ DEBUG: selector element:', selector);
            
            // Visual feedback - make button red while loading
            const refreshBtn = document.querySelector('button[onclick="refreshClientList()"]');
            if (refreshBtn) {
                refreshBtn.style.backgroundColor = '#ff5722';
                refreshBtn.innerHTML = 'üîÑ Loading...';
            }
            
            try {
                console.log('üî¥ DEBUG: Fetching client list from /api/configs');
                const response = await fetch('/api/configs');
                console.log('üî¥ DEBUG: Response status:', response.status);
                
                const data = await response.json();
                console.log('üî¥ DEBUG: Response data:', data);
                
                selector.innerHTML = '<option value="">-- Select a client to load --</option>';
                
                if (data.success && data.configs) {
                    console.log('üî¥ DEBUG: Adding', data.configs.length, 'clients to dropdown');
                    data.configs.forEach((config, index) => {
                        console.log(`üî¥ DEBUG: Adding client ${index + 1}:`, config.siteId, config.clientName);
                        const option = document.createElement('option');
                        option.value = config.siteId;
                        option.textContent = `${config.siteId} - ${config.clientName}`;
                        selector.appendChild(option);
                    });
                    console.log('‚úÖ Client list refreshed:', data.configs.length, 'clients');
                    
                    // Visual feedback - make button green on success
                    if (refreshBtn) {
                        refreshBtn.style.backgroundColor = '#4caf50';
                        refreshBtn.innerHTML = '‚úÖ Loaded ' + data.configs.length + ' clients';
                        setTimeout(() => {
                            refreshBtn.style.backgroundColor = '#28a745';
                            refreshBtn.innerHTML = 'üîÑ Refresh Client List';
                        }, 2000);
                    }
                } else {
                    console.error('‚ùå Failed to load client list:', data);
                    // Visual feedback - make button red on error
                    if (refreshBtn) {
                        refreshBtn.style.backgroundColor = '#f44336';
                        refreshBtn.innerHTML = '‚ùå Failed to load';
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing client list:', error);
                // Visual feedback - make button red on error
                if (refreshBtn) {
                    refreshBtn.style.backgroundColor = '#f44336';
                    refreshBtn.innerHTML = '‚ùå Error loading';
                }
            }
        }

        // Load selected client configuration
        async function loadSelectedClient() {
            console.log('üî¥ DEBUG: loadSelectedClient() called');
            
            const selector = document.getElementById('clientSelector');
            const siteId = selector.value;
            
            console.log('üî¥ DEBUG: selector element:', selector);
            console.log('üî¥ DEBUG: siteId selected:', siteId);
            
            if (!siteId) {
                console.log('üî¥ DEBUG: No siteId selected, returning');
                return;
            }
            
            // Visual feedback - make selector red while loading
            selector.style.border = '3px solid red';
            selector.style.backgroundColor = '#ffebee';
            
            try {
                console.log('üî¥ DEBUG: Fetching config for siteId:', siteId);
                const response = await fetch(`/api/load-config?siteId=${siteId}`);
                console.log('üî¥ DEBUG: Response status:', response.status);
                
                const data = await response.json();
                console.log('üî¥ DEBUG: Response data:', data);
                
                if (data.success && data.config) {
                    console.log('üî¥ DEBUG: About to call populateFormWithConfig');
                    populateFormWithConfig(data.config);
                    console.log('‚úÖ Loaded client config:', siteId);
                    
                    // Visual feedback - make selector green on success
                    selector.style.border = '3px solid green';
                    selector.style.backgroundColor = '#e8f5e8';
                    setTimeout(() => {
                        selector.style.border = '';
                        selector.style.backgroundColor = '';
                    }, 2000);
                } else {
                    console.error('‚ùå Failed to load client config:', data);
                    // Visual feedback - make selector red on error
                    selector.style.border = '3px solid red';
                    selector.style.backgroundColor = '#ffebee';
                }
            } catch (error) {
                console.error('‚ùå Error loading client config:', error);
                // Visual feedback - make selector red on error
                selector.style.border = '3px solid red';
                selector.style.backgroundColor = '#ffebee';
            }
        }

        // Populate form with loaded configuration
        function populateFormWithConfig(config) {
            console.log('üî¥ DEBUG: populateFormWithConfig() called with config:', config);
            
            // Helper function to safely set element value
            const setValue = (id, value) => {
                const element = document.getElementById(id);
                console.log(`üî¥ DEBUG: setValue(${id}, ${value}) - element found:`, !!element);
                if (element) {
                    element.value = value || '';
                    // Visual feedback - flash element green
                    element.style.backgroundColor = '#e8f5e8';
                    element.style.border = '2px solid green';
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                        element.style.border = '';
                    }, 1000);
                } else {
                    console.error(`‚ùå Element with id '${id}' not found!`);
                }
            };
            
            const setChecked = (id, value) => {
                const element = document.getElementById(id);
                console.log(`üî¥ DEBUG: setChecked(${id}, ${value}) - element found:`, !!element);
                if (element) {
                    element.checked = value || false;
                    // Visual feedback - flash element green
                    element.style.backgroundColor = '#e8f5e8';
                    element.style.border = '2px solid green';
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                        element.style.border = '';
                    }, 1000);
                } else {
                    console.error(`‚ùå Element with id '${id}' not found!`);
                }
            };
            
            // Basic settings
            setValue('siteId', config.siteId);
            setValue('clientName', config.clientName);
            setValue('fallbackUrl', config.fallbackUrl);
            
            // Bubble settings
            if (config.bubble) {
                setValue('color', config.bubble.bg);
                setValue('size', config.bubble.size);
                // Handle different position formats
                let position = config.bubble.position || 'bottom-right';
                if (position === 'br') position = 'bottom-right';
                if (position === 'bl') position = 'bottom-left';
                setValue('position', position);
                setValue('icon', config.bubble.icon || config.bubble.iconUrl);
            }
            
            // Trigger settings
            if (config.triggers) {
                setValue('showBubbleAfterMs', config.triggers.showBubbleAfterMs);
                setValue('openAfterMs', config.triggers.openAfterMs);
                setChecked('exitIntent', config.triggers.exitIntent || config.triggers.triggerOnExitIntent);
                setValue('scrollTrigger', config.triggers.scrollTrigger || config.triggers.triggerOnScrollPercent);
            }
            
            // Overlay settings
            if (config.overlay) {
                setValue('overlayBg', config.overlay.bg);
                setValue('windowMode', config.overlay.windowMode ? 'windowed' : 'fullscreen');
                setValue('windowWidth', parseInt(config.overlay.windowWidth));
                setValue('windowHeight', parseInt(config.overlay.windowHeight));
            }
            
            // Rules
            if (config.rules) {
                setChecked('appendUTM', config.rules.appendUTM);
                setChecked('showOnMobile', config.rules.showOnMobile !== false);
                setChecked('showOnDesktop', config.rules.showOnDesktop !== false);
            }
            
            // Analytics
            if (config.analytics) {
                setChecked('trackOpens', config.analytics.trackOpens);
            }
            
            // Advanced settings
            setChecked('noOverlay', config.noOverlay);
            setChecked('teaserEnabled', config.teaserEnabled || (config.teaser && config.teaser.enabled));
            setValue('teaserText', config.teaserText || (config.teaser && config.teaser.text));
            setValue('teaserDelay', config.teaserDelay || (config.teaser && config.teaser.delayMs));
            setValue('teaserAutoclose', config.teaserAutoclose || (config.teaser && config.teaser.autocloseMs));
            setValue('webhookUrl', config.webhookUrl);
            
            console.log('üî¥ DEBUG: About to call updatePreview()');
            updatePreview();
            console.log('üî¥ DEBUG: populateFormWithConfig() completed successfully');
            
            // Visual feedback - show success message
            const successDiv = document.createElement('div');
            successDiv.innerHTML = '‚úÖ CONFIG LOADED SUCCESSFULLY!';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }

        // Load configuration from database on page load
        async function loadFromDatabase() {
            console.log('üî¥ DEBUG: loadFromDatabase() called - loading aiprlassist-default');
            
            try {
                const response = await fetch('/api/load-config?siteId=aiprlassist-default');
                console.log('üî¥ DEBUG: Response status:', response.status);
                
                const data = await response.json();
                console.log('üî¥ DEBUG: Response data:', data);
                
                if (response.ok && data.success) {
                    const config = data.config;
                    console.log('üî¥ DEBUG: About to call populateFormWithConfig with aiprlassist-default');
                    
                    // Use the same function as loadSelectedClient
                    populateFormWithConfig(config);
                    
                    console.log('‚úÖ Loaded default config from database:', data);
                } else {
                    console.error('‚ùå Failed to load default config:', data);
                }
            } catch (error) {
                console.error('‚ùå Error loading default config:', error);
            }
        }

        // Auto-update preview when inputs change
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = [
                'color', 'textColor', 'outlineColor', 'icon', 'bubbleLabel', 'position', 'size', 'zIndex', 'pulse',
                'chatId', 'accountId', 'showBubbleAfterMs', 'openAfterMs', 'scrollTrigger', 'exitIntent',
                'teaserEnabled', 'teaserText', 'teaserDelay', 'teaserAutoclose',
                'minWidth', 'maxWidth', 'frequencyCap', 'trackOpens',
                'includePaths', 'excludePaths', 'showOnMobile', 'showOnDesktop', 'appendUTM',
                'windowMode', 'windowWidth', 'windowHeight', 'overlayBg', 'closeOnEsc', 'fallbackUrl', 'noOverlay'
            ];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
            
            // Load from database on startup
            loadFromDatabase();
            
            // Load client list on startup
            refreshClientList();
        });
    </script>

    <!-- Load the working widget for testing -->
    <script src="https://dynamiccode-ochre.vercel.app/plugin.js"></script>
    <script>
        ChatWidget.setup({
            id: "O1T4KXJ9xZ",
            accountId: "1047143",
            color: "#E67E22",
            showDelay: 1000,
            analytics: true,
            utmCapture: true
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PRL Assist - Simple Plugin Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            min-height: 100vh;
            color: #2c3e50;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: white; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05); 
        }
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.05); 
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            font-size: 14px;
            background: white;
            color: #2c3e50;
        }
        input::placeholder, textarea::placeholder {
            color: #6c757d;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #E67E22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }
        .btn { 
            background: #E67E22; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn:hover { 
            background: #D35400;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .code-block { 
            background: rgba(0,0,0,0.4); 
            color: #E8F4F8; 
            padding: 20px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            overflow-x: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .success { 
            background: rgba(46, 204, 113, 0.2); 
            border: 1px solid #2ecc71; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
        }
        .warning { 
            background: rgba(241, 196, 15, 0.2); 
            border: 1px solid #f1c40f; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
        }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { 
            padding: 12px 24px; 
            background: white; 
            border: 1px solid #e9ecef; 
            cursor: pointer; 
            border-radius: 8px 8px 0 0; 
            margin-right: 2px;
            color: #2c3e50;
            font-weight: 500;
        }
        .tab.active { 
            background: #E67E22; 
            color: white;
            border-color: #E67E22; 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .preview-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 68px;
            height: 68px;
            background: #E67E22;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.2s ease;
        }
        .preview-widget:hover {
            transform: scale(1.1);
        }
        .preview-widget img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ AI PRL Assist - Simple Plugin Control Panel</h1>
            <p>Configure your chat widget with simple, powerful parameters</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
            <button class="tab" onclick="showTab('code')">üìã Client Code</button>
            <button class="tab" onclick="showTab('utm')">üéØ UTM Flow</button>
        </div>

        <div id="config" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>üé® Widget Appearance</h3>
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="text" id="chatId" value="O1T4KXJ9xZ" placeholder="Your chat ID">
                    </div>
                    <div class="form-group">
                        <label>Account ID</label>
                        <input type="text" id="accountId" value="1047143" placeholder="Your account ID">
                    </div>
                    <div class="form-group">
                        <label>Bubble Color</label>
                        <input type="color" id="color" value="#E67E22">
                    </div>
                    <div class="form-group">
                        <label>Text Color</label>
                        <input type="color" id="textColor" value="#ffffff">
                    </div>
                    <div class="form-group">
                        <label>Outline Color</label>
                        <input type="color" id="outlineColor" value="#3498DB">
                    </div>
                    <div class="form-group">
                        <label>Icon URL</label>
                        <input type="url" id="icon" value="https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png">
                    </div>
                    <div class="form-group">
                        <label>Bubble Label/Message</label>
                        <input type="text" id="bubbleLabel" value="Hi! Need help?" placeholder="Message shown on bubble">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="position">
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-left">Bottom Left</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Size (px)</label>
                        <input type="number" id="size" value="68" min="40" max="100">
                    </div>
                    <div class="form-group">
                        <label>Z-Index</label>
                        <input type="number" id="zIndex" value="2147483000" min="1000" max="2147483647">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="pulse" checked> Pulse Animation
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>‚è∞ Triggers & Timing</h3>
                    <div class="form-group">
                        <label>Show Bubble After (ms)</label>
                        <input type="number" id="showBubbleAfterMs" value="3000" min="0" max="60000">
                    </div>
                    <div class="form-group">
                        <label>Auto-Open After (ms) - 0 = disabled</label>
                        <input type="number" id="openAfterMs" value="0" min="0" max="300000">
                    </div>
                    <div class="form-group">
                        <label>Scroll Trigger (%) - 0 = disabled</label>
                        <input type="number" id="scrollTrigger" value="0" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="exitIntent"> Exit Intent Trigger
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üì± Display Rules</h3>
                    <div class="form-group">
                        <label>Include Paths (one per line, * = all)</label>
                        <textarea id="includePaths" rows="3">*</textarea>
                    </div>
                    <div class="form-group">
                        <label>Exclude Paths (one per line)</label>
                        <textarea id="excludePaths" rows="3" placeholder="/admin/*&#10;/checkout/*"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOnMobile" checked> Show on Mobile
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOnDesktop" checked> Show on Desktop
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="appendUTM" checked> Capture UTM Parameters
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üí¨ Teaser Messages</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="teaserEnabled" checked> Enable Teaser Messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Teaser Text</label>
                        <input type="text" id="teaserText" value="üëã Hi! I'm here to help with your retail experience. Got questions?" placeholder="Teaser message text">
                    </div>
                    <div class="form-group">
                        <label>Show Teaser After (ms)</label>
                        <input type="number" id="teaserDelay" value="5000" min="1000" max="30000">
                    </div>
                    <div class="form-group">
                        <label>Auto-close Teaser After (ms)</label>
                        <input type="number" id="teaserAutoclose" value="15000" min="5000" max="60000">
                    </div>
                </div>

                <div class="card">
                    <h3>üéõÔ∏è Advanced Rules</h3>
                    <div class="form-group">
                        <label>Min Screen Width (px)</label>
                        <input type="number" id="minWidth" value="0" min="0" max="2000">
                    </div>
                    <div class="form-group">
                        <label>Max Screen Width (px)</label>
                        <input type="number" id="maxWidth" value="99999" min="320" max="99999">
                    </div>
                    <div class="form-group">
                        <label>Frequency Cap (hours) - 0 = no limit</label>
                        <input type="number" id="frequencyCap" value="24" min="0" max="168">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="trackOpens" checked> Track Chat Opens
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3>üñºÔ∏è Chat Window</h3>
                    <div class="form-group">
                        <label>Window Mode</label>
                        <select id="windowMode">
                            <option value="windowed">Windowed (Desktop)</option>
                            <option value="fullscreen">Fullscreen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Window Width (px)</label>
                        <input type="number" id="windowWidth" value="420" min="300" max="800">
                    </div>
                    <div class="form-group">
                        <label>Window Height (px)</label>
                        <input type="number" id="windowHeight" value="650" min="400" max="900">
                    </div>
                    <div class="form-group">
                        <label>Overlay Background</label>
                        <input type="text" id="overlayBg" value="rgba(0,0,0,0.45)" placeholder="rgba(0,0,0,0.45)">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="closeOnEsc" checked> Close on ESC key
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Fallback URL (if main chat fails)</label>
                        <input type="url" id="fallbackUrl" value="https://app.aiprlassist.com/webchat/?p=1047143&ref=1746442093403">
                    </div>
                </div>

                <div class="card">
                    <h3>üî• Live Preview</h3>
                    <p>Changes reflect instantly below:</p>
                    <div id="livePreview" style="margin-top: 20px; text-align: center;">
                        <div class="preview-widget" id="previewWidget">
                            <img id="previewIcon" src="https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png" alt="Chat">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <button class="btn" onclick="saveToDatabase()" style="background: #28a745; font-size: 18px; padding: 15px 30px;">üíæ SAVE TO DATABASE</button>
                <button class="btn" onclick="updatePreview()">üîÑ Update Preview</button>
                <button class="btn" onclick="testWidget()">üß™ Test Widget</button>
            </div>
        </div>

        <div id="code" class="tab-content">
            <div class="card">
                <h3>üìã Client Code (Copy & Paste)</h3>
                <div class="success">
                    ‚úÖ <strong>Simple and powerful!</strong> Just two script tags.
                </div>
                <div class="code-block" id="clientCode">
&lt;!-- AI PRL Assist Chat Widget (2024 Research-Based Approach) --&gt;
&lt;script&gt;
  window.ChatWidgetSettings = {
    siteId: "aiprlassist-default",
    serverUrl: "https://app.aiprlassist.com/webchat/",
    color: "#E67E22",
    position: "bottom-right",
    size: 68,
    showDelay: 3000,
    utmCapture: true,
    analytics: true
  };
&lt;/script&gt;
&lt;script async src="https://dynamiccode-ochre.vercel.app/widget-improved.js"&gt;&lt;/script&gt;
                </div>
                
                <div class="success">
                    <strong>üöÄ NEW 2024 APPROACH - RESEARCH BASED!</strong><br>
                    ‚úÖ Intercom/Rasa style embedding<br>
                    ‚úÖ Shadow DOM isolation<br>
                    ‚úÖ Async loading (GHL compatible)<br>
                    ‚úÖ Automatic UTM capture<br>
                    ‚úÖ Works on ALL platforms
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è GoHighLevel Instructions:</strong><br>
                    <strong>Method 1 (Recommended):</strong><br>
                    1. Go to <strong>Sites ‚Üí [Your Site] ‚Üí Settings ‚Üí Tracking Code</strong><br>
                    2. Paste the code above in <strong>"Footer Tracking Code"</strong><br>
                    3. Click <strong>Save</strong> and <strong>Publish Site</strong><br>
                    4. Widget appears on all pages automatically<br><br>
                    
                    <strong>Method 2 (If Method 1 fails):</strong><br>
                    1. Go to <strong>Sites ‚Üí [Your Site] ‚Üí Pages</strong><br>
                    2. Edit any page ‚Üí <strong>Settings</strong> (gear icon)<br>
                    3. Scroll to <strong>"Custom Code"</strong> section<br>
                    4. Paste in <strong>"Footer Code"</strong> field<br>
                    5. Save and publish
                </div>
                
                <div class="warning">
                    <strong>üåê Other Platforms (All Compatible):</strong><br>
                    <strong>Webflow:</strong> Project Settings ‚Üí Custom Code ‚Üí Footer Code<br>
                    <strong>WordPress:</strong> Appearance ‚Üí Theme Editor ‚Üí footer.php (before &lt;/body&gt;)<br>
                    <strong>Shopify:</strong> Online Store ‚Üí Themes ‚Üí Edit Code ‚Üí theme.liquid (before &lt;/body&gt;)<br>
                    <strong>Squarespace:</strong> Settings ‚Üí Advanced ‚Üí Code Injection ‚Üí Footer<br>
                    <strong>Wix:</strong> ‚ùå Not supported (Wix blocks external scripts)<br><br>
                    
                    <strong>üí° Pro Tip:</strong> The <code>async</code> attribute ensures the widget doesn't block page loading!
                </div>
            </div>
        </div>

        <div id="utm" class="tab-content">
            <div class="card">
                <h3>üéØ UTM Parameter Flow - Complete End-to-End</h3>
                
                <h4>üì• 1. UTM Capture (Automatic)</h4>
                <p>When someone visits your client's site with UTM parameters:</p>
                <div class="code-block">
https://client-site.com/page?utm_source=facebook&utm_medium=cpc&utm_campaign=promo2024&utm_term=shoes&utm_content=ad1
                </div>
                
                <h4>üîÑ 2. Parameter Processing (plugin.js)</h4>
                <p>The widget automatically captures these parameters from the URL:</p>
                <div class="code-block">
const currentParams = new URLSearchParams(location.search);
['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
  const value = currentParams.get(param);
  if (value) url.searchParams.set(param, value);
});
                </div>
                
                <h4>üì§ 3. Parameter Forwarding</h4>
                <p>When chat opens, ALL parameters are passed to your chat URL:</p>
                <div class="code-block">
https://app.aiprlassist.com/webchat/?p=1047143&id=O1T4KXJ9xZ&embed=1&host=client-site.com&page=https://client-site.com/page&utm_source=facebook&utm_medium=cpc&utm_campaign=promo2024&utm_term=shoes&utm_content=ad1
                </div>
                
                <h4>üí¨ 4. Chat System Access</h4>
                <p>Your chat system receives ALL this data and can:</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>‚úÖ Track which campaign brought the visitor</li>
                    <li>‚úÖ Personalize responses based on source</li>
                    <li>‚úÖ Attribute conversions to specific ads</li>
                    <li>‚úÖ Build detailed analytics reports</li>
                </ul>
                
                <h4>üìä 5. Additional Context</h4>
                <p>Plus automatic page context:</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><code>host</code> - Which domain (client-site.com)</li>
                    <li><code>page</code> - Exact page URL</li>
                    <li><code>ref</code> - Where they came from (if available)</li>
                    <li><code>embed=1</code> - Identifies widget traffic</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function updatePreview() {
            const color = document.getElementById('color').value;
            const icon = document.getElementById('icon').value;
            const size = document.getElementById('size').value;
            
            const previewWidget = document.getElementById('previewWidget');
            const previewIcon = document.getElementById('previewIcon');
            
            previewWidget.style.background = color;
            previewWidget.style.width = size + 'px';
            previewWidget.style.height = size + 'px';
            previewIcon.src = icon;
            
            updateClientCode();
        }

        async function saveToDatabase() {
            const siteId = "aiprlassist-default"; // Use default for now
            const config = {
                chatUrl: "https://app.aiprlassist.com/webchat/?p=" + document.getElementById('accountId').value + "&id=" + document.getElementById('chatId').value,
                fallbackUrl: document.getElementById('fallbackUrl').value,
                bubble: {
                    position: document.getElementById('position').value === 'bottom-left' ? 'bl' : 'br',
                    size: parseInt(document.getElementById('size').value),
                    bg: document.getElementById('color').value,
                    color: document.getElementById('textColor').value,
                    outline: document.getElementById('outlineColor').value,
                    label: document.getElementById('bubbleLabel').value,
                    iconUrl: document.getElementById('icon').value,
                    pulse: document.getElementById('pulse').checked,
                    zIndex: parseInt(document.getElementById('zIndex').value)
                },
                teaser: {
                    enabled: document.getElementById('teaserEnabled').checked,
                    text: document.getElementById('teaserText').value,
                    delayMs: parseInt(document.getElementById('teaserDelay').value),
                    autocloseMs: parseInt(document.getElementById('teaserAutoclose').value)
                },
                triggers: {
                    showBubbleAfterMs: parseInt(document.getElementById('showBubbleAfterMs').value),
                    openAfterMs: parseInt(document.getElementById('openAfterMs').value),
                    triggerOnScrollPercent: parseInt(document.getElementById('scrollTrigger').value),
                    triggerOnExitIntent: document.getElementById('exitIntent').checked
                },
                rules: {
                    includePaths: document.getElementById('includePaths').value.split('\n').filter(p => p.trim()),
                    excludePaths: document.getElementById('excludePaths').value.split('\n').filter(p => p.trim()),
                    showOnMobile: document.getElementById('showOnMobile').checked,
                    showOnDesktop: document.getElementById('showOnDesktop').checked,
                    minWidth: parseInt(document.getElementById('minWidth').value),
                    maxWidth: parseInt(document.getElementById('maxWidth').value),
                    frequencyCapHours: parseInt(document.getElementById('frequencyCap').value),
                    appendUTM: document.getElementById('appendUTM').checked
                },
                overlay: {
                    bg: document.getElementById('overlayBg').value,
                    closeOnEsc: document.getElementById('closeOnEsc').checked,
                    windowMode: document.getElementById('windowMode').value === 'windowed',
                    windowWidth: document.getElementById('windowWidth').value + "px",
                    windowHeight: document.getElementById('windowHeight').value + "px"
                },
                analytics: {
                    console: true,
                    trackOpens: document.getElementById('trackOpens').checked
                }
            };
            
            try {
                const response = await fetch('/api/save-config-real', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        siteId: siteId,
                        clientName: "AI PRL Assist (Default)",
                        config: config
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úÖ SAVED TO DATABASE!\n\nConfiguration updated in Postgres.');
                    updateClientCode();
                } else {
                    alert(`‚ùå SAVE FAILED: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå ERROR: ${error.message}`);
            }
        }

        function updateClientCode() {
            const siteId = "aiprlassist-default"; // TODO: Make this dynamic per client
            
            const code = `&lt;!-- AI PRL Assist Chat Widget (2024 Research-Based) --&gt;
&lt;script&gt;
  window.ChatWidgetSettings = {
    siteId: "${siteId}",
    serverUrl: "${document.getElementById('fallbackUrl').value || 'https://app.aiprlassist.com/webchat/'}",
    color: "${document.getElementById('color').value}",
    position: "${document.getElementById('position').value}",
    size: ${document.getElementById('size').value},
    showDelay: ${document.getElementById('showBubbleAfterMs').value},
    autoOpen: ${document.getElementById('openAfterMs').value > 0},
    icon: "${document.getElementById('icon').value}",
    windowMode: "${document.getElementById('windowMode').value}",
    windowWidth: ${document.getElementById('windowWidth').value},
    windowHeight: ${document.getElementById('windowHeight').value},
    utmCapture: ${document.getElementById('appendUTM').checked},
    analytics: ${document.getElementById('trackOpens').checked},
    fallbackUrl: "${document.getElementById('fallbackUrl').value}"
  };
&lt;/script&gt;
&lt;script async src="https://dynamiccode-ochre.vercel.app/widget-improved.js"&gt;&lt;/script&gt;`;
            
            document.getElementById('clientCode').innerHTML = code;
        }

        function testWidget() {
            // Remove existing test widget
            const existing = document.getElementById('testWidget');
            if (existing) existing.remove();
            
            // Create test script
            const script = document.createElement('script');
            script.innerHTML = `
                if (window.ChatWidget && window.ChatWidget.setup) {
                    ChatWidget.setup({
                        id: "${document.getElementById('chatId').value}",
                        accountId: "${document.getElementById('accountId').value}",
                        color: "${document.getElementById('color').value}",
                        icon: "${document.getElementById('icon').value}",
                        position: "${document.getElementById('position').value}",
                        size: ${document.getElementById('size').value}
                    });
                }
            `;
            script.id = 'testWidget';
            document.body.appendChild(script);
            
            alert('üß™ Test widget loaded! Check bottom-right corner.');
        }

        // Load configuration from database on page load
        async function loadFromDatabase() {
            try {
                const response = await fetch('/api/load-config?siteId=aiprlassist-default');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const config = data.config;
                    
                    // Basic settings
                    document.getElementById('chatId').value = config.chatUrl?.match(/id=([^&]+)/)?.[1] || 'O1T4KXJ9xZ';
                    document.getElementById('accountId').value = config.chatUrl?.match(/p=([^&]+)/)?.[1] || '1047143';
                    
                    // Appearance
                    document.getElementById('color').value = config.bubble?.bg || '#E67E22';
                    document.getElementById('textColor').value = config.bubble?.color || '#ffffff';
                    document.getElementById('outlineColor').value = config.bubble?.outline || '#3498DB';
                    document.getElementById('icon').value = config.bubble?.iconUrl || '';
                    document.getElementById('bubbleLabel').value = config.bubble?.label || 'Hi! Need help?';
                    document.getElementById('position').value = config.bubble?.position === 'bl' ? 'bottom-left' : 'bottom-right';
                    document.getElementById('size').value = config.bubble?.size || 68;
                    document.getElementById('zIndex').value = config.bubble?.zIndex || 2147483000;
                    document.getElementById('pulse').checked = config.bubble?.pulse !== false;
                    
                    // Triggers
                    document.getElementById('showBubbleAfterMs').value = config.triggers?.showBubbleAfterMs || 3000;
                    document.getElementById('openAfterMs').value = config.triggers?.openAfterMs || 0;
                    document.getElementById('scrollTrigger').value = config.triggers?.triggerOnScrollPercent || 0;
                    document.getElementById('exitIntent').checked = config.triggers?.triggerOnExitIntent || false;
                    
                    // Teaser
                    document.getElementById('teaserEnabled').checked = config.teaser?.enabled !== false;
                    document.getElementById('teaserText').value = config.teaser?.text || 'üëã Hi! Need help?';
                    document.getElementById('teaserDelay').value = config.teaser?.delayMs || 5000;
                    document.getElementById('teaserAutoclose').value = config.teaser?.autocloseMs || 15000;
                    
                    // Advanced Rules
                    document.getElementById('minWidth').value = config.rules?.minWidth || 0;
                    document.getElementById('maxWidth').value = config.rules?.maxWidth || 99999;
                    document.getElementById('frequencyCap').value = config.rules?.frequencyCapHours || 24;
                    document.getElementById('trackOpens').checked = config.analytics?.trackOpens !== false;
                    
                    // Rules
                    document.getElementById('includePaths').value = (config.rules?.includePaths || ['*']).join('\n');
                    document.getElementById('excludePaths').value = (config.rules?.excludePaths || []).join('\n');
                    document.getElementById('showOnMobile').checked = config.rules?.showOnMobile !== false;
                    document.getElementById('showOnDesktop').checked = config.rules?.showOnDesktop !== false;
                    document.getElementById('appendUTM').checked = config.rules?.appendUTM !== false;
                    
                    // Overlay
                    document.getElementById('windowMode').value = config.overlay?.windowMode === false ? 'fullscreen' : 'windowed';
                    document.getElementById('windowWidth').value = parseInt(config.overlay?.windowWidth) || 420;
                    document.getElementById('windowHeight').value = parseInt(config.overlay?.windowHeight) || 650;
                    document.getElementById('overlayBg').value = config.overlay?.bg || 'rgba(0,0,0,0.45)';
                    document.getElementById('closeOnEsc').checked = config.overlay?.closeOnEsc !== false;
                    document.getElementById('fallbackUrl').value = config.fallbackUrl || '';
                    
                    updatePreview();
                    updateClientCode();
                    
                    console.log('‚úÖ Loaded config from database:', data);
                } else {
                    console.error('Failed to load config:', data);
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Auto-update preview when inputs change
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = [
                'color', 'textColor', 'outlineColor', 'icon', 'bubbleLabel', 'position', 'size', 'zIndex', 'pulse',
                'chatId', 'accountId', 'showBubbleAfterMs', 'openAfterMs', 'scrollTrigger', 'exitIntent',
                'teaserEnabled', 'teaserText', 'teaserDelay', 'teaserAutoclose',
                'minWidth', 'maxWidth', 'frequencyCap', 'trackOpens',
                'includePaths', 'excludePaths', 'showOnMobile', 'showOnDesktop', 'appendUTM',
                'windowMode', 'windowWidth', 'windowHeight', 'overlayBg', 'closeOnEsc', 'fallbackUrl'
            ];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
            
            // Load from database on startup
            loadFromDatabase();
        });
    </script>

    <!-- Load the new research-based widget for testing -->
    <script>
        window.ChatWidgetSettings = {
            siteId: "control-panel-test",
            color: "#E67E22",
            showDelay: 1000,
            analytics: true
        };
    </script>
    <script async src="https://dynamiccode-ochre.vercel.app/widget-improved.js"></script>
</body>
</html>

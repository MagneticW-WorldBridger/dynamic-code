<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ FRONTEND COMPLETE TEST - AI PRL Assist</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 13px;
        }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #e7f3ff; color: #0c5460; border: 1px solid #b8daff; }
        .pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
            font-weight: 600;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .utm-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="test-section">
            <h1>üß™ FRONTEND COMPLETE TEST</h1>
            <p><strong>Testing that frontend actually uses the backend we proved works</strong></p>
        </header>

        <!-- Test 1: Control Panel Loading -->
        <section class="test-section">
            <h2>üß™ TEST 1: Control Panel Loads Database Config</h2>
            <p>Testing if control panel loads real data from database:</p>
            <button onclick="testControlPanelLoad()">üéõÔ∏è Test Control Panel Load</button>
            <div id="controlPanelResults"></div>
            <iframe id="controlPanelFrame" style="display: none;" src="https://dynamiccode-ochre.vercel.app/control-panel-simple.html"></iframe>
        </section>

        <!-- Test 2: Save Functionality -->
        <section class="test-section">
            <h2>üß™ TEST 2: Save Changes to Database</h2>
            <p>Testing if control panel actually saves changes:</p>
            <div class="test-controls">
                <button onclick="testSaveRed()">üî¥ Save Red Bubble</button>
                <button onclick="testSaveBlue()">üîµ Save Blue Bubble</button>
                <button onclick="testSaveGreen()">üü¢ Save Green Bubble</button>
                <button onclick="verifySaveInDB()">üóÑÔ∏è Verify in Database</button>
            </div>
            <div id="saveResults"></div>
        </section>

        <!-- Test 3: Widget Loading -->
        <section class="test-section">
            <h2>üß™ TEST 3: Widget Loads from Database</h2>
            <p>Testing if widget actually loads config from database API:</p>
            <button onclick="testWidgetLoad()">üéà Test Widget Load</button>
            <button onclick="testWidgetWithUTM()">üéØ Test Widget + UTM</button>
            <div id="widgetResults"></div>
        </section>

        <!-- Test 4: UTM Passthrough -->
        <section class="test-section">
            <h2>üß™ TEST 4: UTM Parameter Passthrough</h2>
            <p>Testing complete UTM flow from URL to chat:</p>
            <div class="utm-test" id="currentUTM">
                Current URL: Loading...
            </div>
            <div class="test-controls">
                <button onclick="addUTMParams()">üéØ Add UTM Params</button>
                <button onclick="testUTMCapture()">üì• Test UTM Capture</button>
                <button onclick="testChatURL()">üí¨ Test Chat URL</button>
            </div>
            <div id="utmResults"></div>
        </section>

        <!-- Live Results -->
        <section class="test-section">
            <h2>üìä Live Test Results</h2>
            <div id="liveResults">
                <div class="pending">Click tests above to see results...</div>
            </div>
        </section>
    </div>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = `[${timestamp}] ${message}`;
            
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = result;
            
            document.getElementById('liveResults').appendChild(div);
            document.getElementById('liveResults').scrollTop = document.getElementById('liveResults').scrollHeight;
            
            console.log(`[FRONTEND TEST] ${message}`);
        }

        // Test 1: Control Panel Loading
        async function testControlPanelLoad() {
            log('üß™ TESTING: Control panel loads database config', 'info');
            
            try {
                // Test the API directly first
                const response = await fetch('/api/load-config?siteId=aiprlassist-default');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ PASS: API loads config (${data.clientName})`, 'pass');
                    
                    // Show the control panel iframe
                    const iframe = document.getElementById('controlPanelFrame');
                    iframe.style.display = 'block';
                    
                    document.getElementById('controlPanelResults').innerHTML = `
                        <div class="test-result pass">‚úÖ Control panel should auto-load this data:</div>
                        <div class="test-result info">
                            ‚Ä¢ Client: ${data.clientName}<br>
                            ‚Ä¢ Chat ID: ${data.config.chatUrl?.match(/id=([^&]+)/)?.[1]}<br>
                            ‚Ä¢ Bubble Color: ${data.config.bubble?.bg}<br>
                            ‚Ä¢ Size: ${data.config.bubble?.size}px<br>
                            ‚Ä¢ Position: ${data.config.bubble?.position}
                        </div>
                    `;
                    
                    return true;
                } else {
                    log('‚ùå FAIL: API failed to load config', 'fail');
                    return false;
                }
            } catch (error) {
                log(`‚ùå FAIL: Control panel test error: ${error.message}`, 'fail');
                return false;
            }
        }

        // Test 2: Save Functionality
        async function testSaveRed() {
            await testSaveColor('#FF0000', 'RED');
        }

        async function testSaveBlue() {
            await testSaveColor('#0000FF', 'BLUE');
        }

        async function testSaveGreen() {
            await testSaveColor('#00FF00', 'GREEN');
        }

        async function testSaveColor(color, colorName) {
            log(`üß™ TESTING: Save ${colorName} bubble to database`, 'info');
            
            const config = {
                chatUrl: "https://app.aiprlassist.com/webchat/?p=1047143&id=TEST123",
                fallbackUrl: "https://app.aiprlassist.com/webchat/?p=1047143&ref=TEST456",
                bubble: {
                    position: "br",
                    size: 68,
                    bg: color,
                    color: "#ffffff",
                    iconUrl: "https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png",
                    pulse: true,
                    zIndex: 2147483000
                },
                triggers: {
                    showBubbleAfterMs: 3000,
                    openAfterMs: 0,
                    triggerOnScrollPercent: 0,
                    triggerOnExitIntent: false
                },
                rules: {
                    includePaths: ["*"],
                    excludePaths: [],
                    showOnMobile: true,
                    showOnDesktop: true,
                    appendUTM: true
                },
                overlay: {
                    bg: "rgba(0,0,0,0.45)",
                    closeOnEsc: true,
                    windowMode: true,
                    windowWidth: "420px",
                    windowHeight: "650px"
                },
                analytics: {
                    console: true
                }
            };
            
            try {
                const response = await fetch('/api/save-config-real', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        siteId: 'aiprlassist-default',
                        clientName: `Test ${colorName} Client`,
                        config: config
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    log(`‚úÖ PASS: ${colorName} config saved to database (ID: ${result.id})`, 'pass');
                    
                    document.getElementById('saveResults').innerHTML = `
                        <div class="test-result pass">‚úÖ ${colorName} configuration saved successfully!</div>
                        <div class="test-result info">Database ID: ${result.id} | Updated: ${result.updatedAt}</div>
                    `;
                } else {
                    log(`‚ùå FAIL: ${colorName} save failed: ${result.error}`, 'fail');
                }
            } catch (error) {
                log(`‚ùå FAIL: ${colorName} save error: ${error.message}`, 'fail');
            }
        }

        // Verify save in database
        async function verifySaveInDB() {
            log('üß™ TESTING: Verify save in database', 'info');
            
            try {
                const response = await fetch('/api/load-config?siteId=aiprlassist-default');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const bubbleColor = data.config.bubble?.bg;
                    log(`‚úÖ PASS: Database contains color: ${bubbleColor}`, 'pass');
                    
                    document.getElementById('saveResults').innerHTML += `
                        <div class="test-result pass">‚úÖ Verified in database: Color is ${bubbleColor}</div>
                        <div class="test-result info">Updated: ${data.updatedAt}</div>
                    `;
                } else {
                    log('‚ùå FAIL: Could not verify in database', 'fail');
                }
            } catch (error) {
                log(`‚ùå FAIL: Database verification error: ${error.message}`, 'fail');
            }
        }

        // Test 3: Widget Loading
        async function testWidgetLoad() {
            log('üß™ TESTING: Widget loads from database', 'info');
            
            // Remove existing widget
            const existing = document.getElementById('testWidget');
            if (existing) existing.remove();
            
            // Load database widget
            const script = document.createElement('script');
            script.id = 'testWidget';
            script.src = 'https://dynamiccode-ochre.vercel.app/chat-widget-db.js';
            script.onload = () => {
                if (window.ChatWidget && window.ChatWidget.setup) {
                    window.ChatWidget.setup({
                        siteId: "aiprlassist-default",
                        analytics: true
                    });
                    
                    log('‚úÖ PASS: Widget loaded with database config', 'pass');
                    
                    document.getElementById('widgetResults').innerHTML = `
                        <div class="test-result pass">‚úÖ Widget loaded from database!</div>
                        <div class="test-result info">Check bottom-right corner for widget bubble</div>
                        <button onclick="if(window.ChatWidget) window.ChatWidget.open()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">üí¨ Open Chat</button>
                    `;
                } else {
                    log('‚ùå FAIL: Widget setup failed', 'fail');
                }
            };
            script.onerror = () => {
                log('‚ùå FAIL: Widget script failed to load', 'fail');
            };
            
            document.head.appendChild(script);
        }

        // Test 4: UTM Parameters
        function addUTMParams() {
            const newURL = window.location.pathname + '?utm_source=frontend_test&utm_medium=testing&utm_campaign=widget_test&utm_term=ai_chat&utm_content=complete_test';
            window.history.pushState({}, '', newURL);
            updateUTMDisplay();
            log('‚úÖ PASS: UTM parameters added to URL', 'pass');
        }

        function updateUTMDisplay() {
            const url = window.location.href;
            const params = new URLSearchParams(window.location.search);
            const utmParams = [];
            
            ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                const value = params.get(param);
                if (value) utmParams.push(`${param}=${value}`);
            });
            
            document.getElementById('currentUTM').innerHTML = `
                Current URL: ${url}<br>
                UTM Parameters: ${utmParams.length ? utmParams.join(', ') : 'None'}
            `;
        }

        function testUTMCapture() {
            log('üß™ TESTING: UTM parameter capture', 'info');
            
            const params = new URLSearchParams(window.location.search);
            const capturedUTM = {};
            
            ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                const value = params.get(param);
                if (value) capturedUTM[param] = value;
            });
            
            const capturedCount = Object.keys(capturedUTM).length;
            
            if (capturedCount > 0) {
                log(`‚úÖ PASS: Captured ${capturedCount} UTM parameters`, 'pass');
                
                document.getElementById('utmResults').innerHTML = `
                    <div class="test-result pass">‚úÖ UTM Capture Working: ${capturedCount} parameters</div>
                    <div class="test-result info">${Object.entries(capturedUTM).map(([k,v]) => `${k}: ${v}`).join('<br>')}</div>
                `;
            } else {
                log('‚ùå FAIL: No UTM parameters captured', 'fail');
                document.getElementById('utmResults').innerHTML = `
                    <div class="test-result fail">‚ùå No UTM parameters found</div>
                    <div class="test-result info">Click "Add UTM Params" first</div>
                `;
            }
        }

        function testChatURL() {
            log('üß™ TESTING: Chat URL generation with UTM', 'info');
            
            try {
                // Simulate widget's URL building
                const baseURL = 'https://app.aiprlassist.com/webchat/?p=1047143&id=xaLiCGQ3VYp6mQF2k';
                const url = new URL(baseURL);
                
                // Add embed flag
                url.searchParams.set('embed', '1');
                url.searchParams.set('host', window.location.hostname);
                url.searchParams.set('page', window.location.href);
                
                // Add UTM parameters
                const params = new URLSearchParams(window.location.search);
                ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                    const value = params.get(param);
                    if (value) url.searchParams.set(param, value);
                });
                
                const finalURL = url.toString();
                const totalParams = Array.from(url.searchParams.entries()).length;
                
                log(`‚úÖ PASS: Chat URL built with ${totalParams} parameters`, 'pass');
                
                document.getElementById('utmResults').innerHTML += `
                    <div class="test-result pass">‚úÖ Chat URL generated with ${totalParams} parameters</div>
                    <div class="test-result info" style="word-break: break-all; font-size: 11px;">${finalURL}</div>
                `;
                
            } catch (error) {
                log(`‚ùå FAIL: Chat URL generation error: ${error.message}`, 'fail');
            }
        }

        function testWidgetWithUTM() {
            log('üß™ TESTING: Widget with UTM parameters', 'info');
            
            // First add UTM params
            addUTMParams();
            
            // Then test widget
            setTimeout(() => {
                testWidgetLoad();
            }, 500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateUTMDisplay();
            log('Frontend Complete Test Suite initialized', 'info');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß FINAL BUG FIX VERIFICATION</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 40px;
            background: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        .bug-fix {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .position-indicator {
            position: fixed;
            width: 80px;
            height: 80px;
            background: rgba(255, 0, 0, 0.2);
            border: 3px solid red;
            border-radius: 50%;
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: red;
        }
        .left-indicator {
            left: 20px;
            bottom: 20px;
        }
        .right-indicator {
            right: 20px;
            bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üîß FINAL BUG FIX VERIFICATION</h1>
    
    <div class="bug-fix">
        <h3>üêõ BUGS FIXED:</h3>
        <ul>
            <li><strong>Position Bug:</strong> Fixed plugin.js and widget-improved.js to handle "bl"/"br" correctly</li>
            <li><strong>Icon Bug:</strong> Fixed plugin.js to use iconUrl field from database</li>
            <li><strong>Multiple Systems:</strong> All 3 widget systems now have consistent logic</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>üß™ COMPREHENSIVE TESTS:</h3>
        
        <h4>Test 1: aiprlassist-default (should be LEFT)</h4>
        <p><strong>Database:</strong> position = "bl", iconUrl = "...68b0de8a..."</p>
        <button onclick="testConfig1()">Test aiprlassist-default</button>
        
        <h4>Test 2: cliente-orange-001 (should be RIGHT)</h4>
        <p><strong>Database:</strong> position = "br", iconUrl = "...cloud-rain-alt.svg"</p>
        <button onclick="testConfig2()">Test cliente-orange-001</button>
        
        <button onclick="clearWidgets()">‚ùå Clear All Widgets</button>
        
        <div id="results" class="results"></div>
    </div>

    <!-- Position indicators -->
    <div class="position-indicator left-indicator">BL<br>LEFT</div>
    <div class="position-indicator right-indicator">BR<br>RIGHT</div>

    <script>
        let results = document.getElementById('results');
        
        function log(message) {
            results.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            results.scrollTop = results.scrollHeight;
        }

        function clearWidgets() {
            // Remove all widget elements
            const widgets = document.querySelectorAll('.ai-prl-chat-bubble, .ai-prl-chat-overlay, .ai-prl-smart-message, .ai-prl-chat-close, .ai-prl-teaser');
            widgets.forEach(w => w.remove());
            
            // Reset loaded flag
            window.__aiPrlAssistLoaded = false;
            
            log('üßπ All widgets cleared');
        }

        async function testConfig1() {
            clearWidgets();
            log('üîÑ Testing aiprlassist-default (should be LEFT)...');
            
            // Load API data first
            try {
                const response = await fetch('https://dynamiccode-ochre.vercel.app/api/load-config?siteId=aiprlassist-default');
                const data = await response.json();
                
                log('üìä DB Data: position=' + data.config.bubble.position + ', iconUrl=' + data.config.bubble.iconUrl.substring(0, 50) + '...');
                
                // Load widget
                const script = document.createElement('script');
                script.src = 'https://dynamiccode-ochre.vercel.app/chat-widget-db.js?' + Date.now();
                script.onload = () => {
                    window.ChatWidget.setup({
                        siteId: 'aiprlassist-default',
                        analytics: true
                    });
                    
                    setTimeout(() => verifyWidget('LEFT', data.config.bubble.iconUrl), 2000);
                };
                document.head.appendChild(script);
                
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }

        async function testConfig2() {
            clearWidgets();
            log('üîÑ Testing cliente-orange-001 (should be RIGHT)...');
            
            // Load API data first
            try {
                const response = await fetch('https://dynamiccode-ochre.vercel.app/api/load-config?siteId=cliente-orange-001');
                const data = await response.json();
                
                log('üìä DB Data: position=' + data.config.bubble.position + ', iconUrl=' + data.config.bubble.iconUrl);
                
                // Load widget
                const script = document.createElement('script');
                script.src = 'https://dynamiccode-ochre.vercel.app/chat-widget-db.js?' + Date.now();
                script.onload = () => {
                    window.ChatWidget.setup({
                        siteId: 'cliente-orange-001',
                        analytics: true
                    });
                    
                    setTimeout(() => verifyWidget('RIGHT', data.config.bubble.iconUrl), 2000);
                };
                document.head.appendChild(script);
                
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }

        function verifyWidget(expectedPosition, expectedIcon) {
            const bubble = document.querySelector('.ai-prl-chat-bubble');
            
            if (!bubble) {
                log('‚ùå NO BUBBLE FOUND!');
                return;
            }

            const styles = window.getComputedStyle(bubble);
            const leftValue = styles.left;
            const rightValue = styles.right;
            
            log('üîç CSS Values: left=' + leftValue + ', right=' + rightValue);
            
            // Determine actual position
            let actualPosition = 'UNKNOWN';
            if (leftValue !== 'auto' && leftValue !== '0px' && parseInt(leftValue) > 0) {
                actualPosition = 'LEFT';
            } else if (rightValue !== 'auto' && rightValue !== '0px' && parseInt(rightValue) > 0) {
                actualPosition = 'RIGHT';
            }
            
            log('üìç Expected: ' + expectedPosition + ', Actual: ' + actualPosition);
            
            if (actualPosition === expectedPosition) {
                log('‚úÖ POSITION CORRECT!');
            } else {
                log('‚ùå POSITION BUG! Expected ' + expectedPosition + ' but got ' + actualPosition);
            }

            // Check icon
            const img = bubble.querySelector('img');
            if (img) {
                log('üñºÔ∏è Icon src: ' + img.src);
                log('üñºÔ∏è Expected: ' + expectedIcon);
                
                if (img.src === expectedIcon) {
                    log('‚úÖ ICON CORRECT!');
                } else {
                    log('‚ùå ICON BUG! URLs don\'t match');
                }
                
                if (img.complete) {
                    log('‚úÖ ICON LOADED!');
                } else {
                    log('‚è≥ Icon still loading...');
                }
            } else {
                log('‚ùå NO ICON FOUND!');
            }

            // Check other properties
            log('üé® Background: ' + styles.backgroundColor);
            log('üìè Size: ' + styles.width + ' x ' + styles.height);
        }

        // Auto-start
        window.onload = () => {
            log('üöÄ Bug fix verification ready!');
            log('üëÜ Click buttons above to test each configuration');
            log('üî¥ Red circles show where widgets should appear');
        };
    </script>
</body>
</html>






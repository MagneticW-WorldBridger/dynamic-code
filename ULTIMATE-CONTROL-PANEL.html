<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéõÔ∏è ULTIMATE Control Panel - AI PRL Assist</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #E67E22, #3498DB); color: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; text-align: center; }
        .panel-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #E67E22; }
        button { background: #E67E22; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 5px; }
        button:hover { background: #D35400; }
        button.secondary { background: #6c757d; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; overflow-x: auto; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin: 10px 0; }
        .info { background: #e7f3ff; color: #0c5460; padding: 12px; border-radius: 6px; margin: 10px 0; }
        .preview-widget { position: fixed; bottom: 20px; right: 20px; width: 68px; height: 68px; background: #E67E22; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .preview-widget img { width: 70%; height: 70%; object-fit: contain; }
        .section-title { color: #E67E22; font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #E67E22; padding-bottom: 8px; }
        .feature-toggle { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
        .toggle-switch { position: relative; width: 50px; height: 25px; background: #ccc; border-radius: 25px; cursor: pointer; }
        .toggle-switch.active { background: #E67E22; }
        .toggle-slider { position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.active .toggle-slider { transform: translateX(25px); }
        .tabs { display: flex; background: white; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px 20px; background: #f8f9fa; border: none; cursor: pointer; font-weight: 600; }
        .tab.active { background: #E67E22; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéõÔ∏è ULTIMATE Control Panel</h1>
            <p>Complete Widget Configuration + UTM Tracking + Webhook Communication</p>
            <div style="margin-top: 15px;">
                <span id="dbStatus">üîÑ Checking database...</span>
                <span style="margin-left: 20px;" id="apiStatus">üîÑ Testing API...</span>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('client')">üë§ Client Management</button>
            <button class="tab" onclick="showTab('widget')">üé® Widget Design</button>
            <button class="tab" onclick="showTab('utm')">üéØ UTM & Tracking</button>
            <button class="tab" onclick="showTab('webhooks')">üîó Webhook Events</button>
            <button class="tab" onclick="showTab('deploy')">üöÄ Deploy & Test</button>
        </div>

        <!-- Tab 1: Client Management -->
        <div id="client" class="tab-content active">
            <div class="panel-grid">
                <div class="panel">
                    <div class="section-title">üìã Select Client</div>
                    <select id="clientSelect" onchange="loadClient()">
                        <option value="">Choose existing client...</option>
                        <option value="aiprlassist-default">AI PRL Assist (Default)</option>
                    </select>
                    <button onclick="loadClient()" style="width: 100%; margin-top: 10px;">üì• Load Configuration</button>
                </div>
                
                <div class="panel">
                    <div class="section-title">‚ûï Create New Client</div>
                    <div class="form-group">
                        <label>Site ID</label>
                        <input type="text" id="newSiteId" placeholder="client-name-001" pattern="[a-z0-9-]+">
                    </div>
                    <div class="form-group">
                        <label>Client Name</label>
                        <input type="text" id="newClientName" placeholder="Client Display Name">
                    </div>
                    <button onclick="createClient()" style="width: 100%;">üÜï Create Client</button>
                </div>
                
                <div class="panel">
                    <div class="section-title">üìä Client Status</div>
                    <div id="clientStatus">
                        <div class="info">Select or create a client to begin configuration</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Widget Design -->
        <div id="widget" class="tab-content">
            <div class="panel-grid">
                <div class="panel">
                    <div class="section-title">üí¨ Chat Configuration</div>
                    <div class="form-group">
                        <label>Primary Chat URL</label>
                        <input type="url" id="chatUrl" value="https://app.aiprlassist.com/webchat/?p=1047143&id=xaLiCGQ3VYp6mQF2k">
                    </div>
                    <div class="form-group">
                        <label>Fallback Chat URL</label>
                        <input type="url" id="fallbackUrl" value="https://app.aiprlassist.com/webchat/?p=1047143&ref=1746442093403">
                    </div>
                    <div class="form-group">
                        <label>Webhook URL (for chat events)</label>
                        <input type="url" id="webhookUrl" placeholder="https://your-api.com/webhook/chat-events">
                        <small>Optional: Receive chat open/close events</small>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">üé® Bubble Appearance</div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="color" id="bubbleColor" value="#E67E22" onchange="updatePreview()">
                    </div>
                    <div class="form-group">
                        <label>Size: <span id="sizeLabel">68px</span></label>
                        <input type="range" id="bubbleSize" min="40" max="100" value="68" oninput="updateSizeLabel(); updatePreview()">
                    </div>
                    <div class="form-group">
                        <label>Icon URL</label>
                        <input type="url" id="iconUrl" value="https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png" onchange="updatePreview()">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="position" onchange="updatePreview()">
                            <option value="br">Bottom Right</option>
                            <option value="bl">Bottom Left</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bubble Text (optional)</label>
                        <input type="text" id="bubbleLabel" placeholder="Need help?">
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">‚è∞ Timing & Triggers</div>
                    <div class="form-group">
                        <label>Show Delay: <span id="delayLabel">3000ms</span></label>
                        <input type="range" id="showDelay" min="0" max="10000" step="500" value="3000" oninput="updateDelayLabel()">
                    </div>
                    <div class="form-group">
                        <label>Auto-open Delay (0 = never)</label>
                        <input type="number" id="openDelay" value="0" min="0" max="30000" step="1000">
                    </div>
                    <div class="feature-toggle">
                        <label>Exit Intent Trigger</label>
                        <div class="toggle-switch" id="exitIntentToggle" onclick="toggleFeature('exitIntent')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Scroll Trigger: <span id="scrollLabel">Disabled</span></label>
                        <input type="range" id="scrollTrigger" min="0" max="95" value="0" oninput="updateScrollLabel()">
                    </div>
                    <div class="feature-toggle">
                        <label>Mobile Full Screen</label>
                        <div class="toggle-switch active" id="mobileFullscreenToggle" onclick="toggleFeature('mobileFullscreen')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="section-title">üñ•Ô∏è Window Settings</div>
                <div class="panel-grid">
                    <div>
                        <div class="form-group">
                            <label>Desktop Width (px)</label>
                            <input type="number" id="windowWidth" value="420" min="300" max="800">
                        </div>
                        <div class="form-group">
                            <label>Desktop Height (px)</label>
                            <input type="number" id="windowHeight" value="650" min="400" max="900">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Overlay Background</label>
                            <input type="text" id="overlayBg" value="rgba(0,0,0,0.45)">
                        </div>
                        <div class="feature-toggle">
                            <label>Close on ESC Key</label>
                            <div class="toggle-switch active" id="closeOnEscToggle" onclick="toggleFeature('closeOnEsc')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="feature-toggle">
                            <label>Console Analytics</label>
                            <div class="toggle-switch active" id="analyticsToggle" onclick="toggleFeature('analytics')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="feature-toggle">
                            <label>Pulse Animation</label>
                            <div class="toggle-switch active" id="pulseToggle" onclick="toggleFeature('pulse')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: UTM & Tracking -->
        <div id="utm" class="tab-content">
            <div class="panel-grid">
                <div class="panel">
                    <div class="section-title">üéØ UTM Parameter Capture</div>
                    <div class="feature-toggle">
                        <label>Enable UTM Capture</label>
                        <div class="toggle-switch active" id="utmCaptureToggle" onclick="toggleFeature('utmCapture')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="info">
                        <strong>UTM Parameters Captured:</strong><br>
                        ‚Ä¢ utm_source (campaign source)<br>
                        ‚Ä¢ utm_medium (campaign medium)<br>
                        ‚Ä¢ utm_campaign (campaign name)<br>
                        ‚Ä¢ utm_term (keywords)<br>
                        ‚Ä¢ utm_content (ad content)
                    </div>
                    <div class="form-group">
                        <label>Custom Parameters (comma-separated)</label>
                        <input type="text" id="customParams" placeholder="gclid,fbclid,custom_param">
                        <small>Additional parameters to capture and forward</small>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">üìä Analytics Integration</div>
                    <div class="form-group">
                        <label>Google Analytics ID</label>
                        <input type="text" id="gaId" placeholder="G-XXXXXXXXXX">
                    </div>
                    <div class="form-group">
                        <label>Facebook Pixel ID</label>
                        <input type="text" id="fbPixelId" placeholder="123456789012345">
                    </div>
                    <div class="feature-toggle">
                        <label>Track Chat Opens</label>
                        <div class="toggle-switch active" id="trackOpensToggle" onclick="toggleFeature('trackOpens')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="feature-toggle">
                        <label>Track Page Context</label>
                        <div class="toggle-switch active" id="trackPageToggle" onclick="toggleFeature('trackPage')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">üîç UTM Testing</div>
                    <button onclick="testUTMCapture()" style="width: 100%;">üß™ Test UTM Capture</button>
                    <div id="utmTestResults"></div>
                    <div class="info">
                        <strong>Current Page UTMs:</strong><br>
                        <span id="currentUTMs">None detected</span>
                    </div>
                    <button onclick="simulateUTMs()" class="secondary" style="width: 100%;">üìù Simulate UTM Parameters</button>
                </div>
            </div>
        </div>

        <!-- Tab 4: Webhook Events -->
        <div id="webhooks" class="tab-content">
            <div class="panel-grid">
                <div class="panel">
                    <div class="section-title">üîó Webhook Configuration</div>
                    <div class="form-group">
                        <label>Webhook Endpoint URL</label>
                        <input type="url" id="webhookEndpoint" placeholder="https://your-api.com/webhooks/chat">
                    </div>
                    <div class="form-group">
                        <label>Webhook Secret (optional)</label>
                        <input type="password" id="webhookSecret" placeholder="your-secret-key">
                        <small>For signature verification</small>
                    </div>
                    <div class="feature-toggle">
                        <label>Enable Webhooks</label>
                        <div class="toggle-switch" id="webhooksEnabledToggle" onclick="toggleFeature('webhooksEnabled')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">üì° Events to Send</div>
                    <div class="feature-toggle">
                        <label>Chat Opened</label>
                        <div class="toggle-switch active" id="webhookChatOpenToggle" onclick="toggleFeature('webhookChatOpen')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="feature-toggle">
                        <label>Chat Closed</label>
                        <div class="toggle-switch active" id="webhookChatCloseToggle" onclick="toggleFeature('webhookChatClose')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="feature-toggle">
                        <label>Bubble Shown</label>
                        <div class="toggle-switch" id="webhookBubbleShownToggle" onclick="toggleFeature('webhookBubbleShown')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="feature-toggle">
                        <label>Page Load</label>
                        <div class="toggle-switch" id="webhookPageLoadToggle" onclick="toggleFeature('webhookPageLoad')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">üß™ Webhook Testing</div>
                    <button onclick="testWebhook()" style="width: 100%;">üîî Send Test Webhook</button>
                    <div id="webhookTestResults"></div>
                    <div class="code-block" style="font-size: 10px;">
Example Webhook Payload:
{
  "event": "chat_opened",
  "siteId": "client-001",
  "timestamp": "2025-09-04T00:00:00Z",
  "data": {
    "utm_source": "facebook",
    "utm_campaign": "summer_sale",
    "host": "client-site.com",
    "page": "https://client-site.com/products",
    "referrer": "https://facebook.com"
  }
}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: Deploy & Test -->
        <div id="deploy" class="tab-content">
            <div class="panel">
                <div class="section-title">üöÄ Client Deployment Code</div>
                <div class="success" id="deploySuccess" style="display: none;">
                    ‚úÖ Configuration saved! Use this code on your client's website:
                </div>
                <div class="code-block" id="deployCode">
Select a client and configure the widget to generate deployment code...
                </div>
                <button onclick="copyDeployCode()">üìã Copy to Clipboard</button>
                <button onclick="testLiveWidget()" class="success">üß™ Test Live Widget</button>
            </div>

            <div class="panel-grid">
                <div class="panel">
                    <div class="section-title">üìã Platform Instructions</div>
                    <div class="form-group">
                        <label>Platform</label>
                        <select id="platformSelect" onchange="showPlatformInstructions()">
                            <option value="">Select platform...</option>
                            <option value="ghl">GoHighLevel</option>
                            <option value="webflow">Webflow</option>
                            <option value="wordpress">WordPress</option>
                            <option value="shopify">Shopify</option>
                            <option value="custom">Custom HTML</option>
                        </select>
                    </div>
                    <div id="platformInstructions"></div>
                </div>

                <div class="panel">
                    <div class="section-title">üîß Advanced Settings</div>
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="url" id="apiBaseUrl" value="https://dynamiccode-ochre.vercel.app">
                    </div>
                    <div class="form-group">
                        <label>Widget Version</label>
                        <select id="widgetVersion">
                            <option value="chat-widget-db.js">Database Version (Recommended)</option>
                            <option value="plugin.js">Inline Version (Backup)</option>
                        </select>
                    </div>
                    <button onclick="exportConfiguration()" class="secondary">üì§ Export Config JSON</button>
                    <button onclick="importConfiguration()" class="secondary">üì• Import Config JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Widget -->
    <div class="preview-widget" id="previewWidget" onclick="testPreviewClick()">
        <img id="previewIcon" src="https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png" alt="Chat">
    </div>

    <script>
        let currentSiteId = null;
        let currentConfig = {};
        let featureStates = {
            exitIntent: false,
            mobileFullscreen: true,
            closeOnEsc: true,
            analytics: true,
            pulse: true,
            utmCapture: true,
            trackOpens: true,
            trackPage: true,
            webhooksEnabled: false,
            webhookChatOpen: true,
            webhookChatClose: true,
            webhookBubbleShown: false,
            webhookPageLoad: false
        };

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Feature Toggle Management
        function toggleFeature(featureName) {
            featureStates[featureName] = !featureStates[featureName];
            const toggle = document.getElementById(featureName + 'Toggle');
            if (featureStates[featureName]) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        // Load client configuration
        async function loadClient() {
            console.log('üì• [Control Panel] Loading client configuration...');
            
            const siteId = document.getElementById('clientSelect').value;
            console.log('üì• [Control Panel] Selected siteId:', siteId);
            
            if (!siteId) {
                console.warn('‚ö†Ô∏è [Control Panel] No siteId selected, aborting load');
                return;
            }
            
            currentSiteId = siteId;
            updateClientStatus('üîÑ Loading configuration...', 'info');
            
            try {
                console.log('üîÑ [Control Panel] Making API call to:', `/api/config-simple?siteId=${siteId}`);
                
                const response = await fetch(`/api/config-simple?siteId=${siteId}`);
                console.log('üì° [Control Panel] API response status:', response.status);
                
                const data = await response.json();
                console.log('üì° [Control Panel] API response data:', data);
                
                if (response.ok && data.success) {
                    console.log('‚úÖ [Control Panel] Configuration loaded successfully');
                    currentConfig = data.config;
                    populateForm(data.config);
                    updateClientStatus(`‚úÖ Loaded: ${data.clientName}`, 'success');
                    generateDeployCode();
                    console.log('‚úÖ [Control Panel] Form populated and deploy code generated');
                } else {
                    console.error('‚ùå [Control Panel] API returned error:', data);
                    updateClientStatus(`‚ùå Failed to load: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå [Control Panel] Load client error:', error);
                updateClientStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Create new client
        function createClient() {
            console.log('üÜï [Control Panel] Creating new client...');
            
            const siteId = document.getElementById('newSiteId').value.trim();
            const clientName = document.getElementById('newClientName').value.trim();
            
            console.log('üÜï [Control Panel] Site ID:', siteId);
            console.log('üÜï [Control Panel] Client Name:', clientName);
            
            if (!siteId) {
                console.error('‚ùå [Control Panel] No Site ID provided');
                alert('Please enter a Site ID');
                return;
            }
            
            if (!/^[a-z0-9-]+$/.test(siteId)) {
                console.error('‚ùå [Control Panel] Invalid Site ID format:', siteId);
                alert('Site ID must contain only lowercase letters, numbers, and hyphens');
                return;
            }
            
            console.log('‚úÖ [Control Panel] Site ID validation passed');
            currentSiteId = siteId;
            
            // Add to dropdown
            console.log('üîÑ [Control Panel] Adding to client dropdown...');
            const select = document.getElementById('clientSelect');
            const option = document.createElement('option');
            option.value = siteId;
            option.textContent = clientName || siteId;
            option.selected = true;
            select.appendChild(option);
            console.log('‚úÖ [Control Panel] Added to dropdown');
            
            // Set default config
            console.log('üîÑ [Control Panel] Setting default configuration...');
            setDefaultConfig();
            console.log('‚úÖ [Control Panel] Default configuration set');
            
            updateClientStatus(`‚úÖ New client "${siteId}" created`, 'success');
            generateDeployCode();
            
            // Clear inputs
            document.getElementById('newSiteId').value = '';
            document.getElementById('newClientName').value = '';
            
            console.log('üéâ [Control Panel] Client creation complete!');
        }

        // Populate form with configuration
        function populateForm(config) {
            document.getElementById('chatUrl').value = config.chatUrl || '';
            document.getElementById('fallbackUrl').value = config.fallbackUrl || '';
            document.getElementById('bubbleColor').value = config.bubble?.bg || '#E67E22';
            document.getElementById('bubbleSize').value = config.bubble?.size || 68;
            document.getElementById('iconUrl').value = config.bubble?.iconUrl || '';
            document.getElementById('position').value = config.bubble?.position || 'br';
            document.getElementById('bubbleLabel').value = config.bubble?.label || '';
            document.getElementById('showDelay').value = config.triggers?.showBubbleAfterMs || 3000;
            document.getElementById('openDelay').value = config.triggers?.openAfterMs || 0;
            document.getElementById('windowWidth').value = parseInt(config.overlay?.windowWidth) || 420;
            document.getElementById('windowHeight').value = parseInt(config.overlay?.windowHeight) || 650;
            document.getElementById('overlayBg').value = config.overlay?.bg || 'rgba(0,0,0,0.45)';
            
            // Update feature states
            featureStates.exitIntent = config.triggers?.triggerOnExitIntent || false;
            featureStates.analytics = config.analytics?.console !== false;
            featureStates.utmCapture = config.rules?.appendUTM !== false;
            featureStates.pulse = config.bubble?.pulse !== false;
            featureStates.closeOnEsc = config.overlay?.closeOnEsc !== false;
            
            // Update toggles
            Object.keys(featureStates).forEach(feature => {
                const toggle = document.getElementById(feature + 'Toggle');
                if (toggle) {
                    if (featureStates[feature]) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }
            });
            
            updateLabels();
            updatePreview();
        }

        // Set default configuration
        function setDefaultConfig() {
            document.getElementById('chatUrl').value = 'https://app.aiprlassist.com/webchat/?p=1047143&id=xaLiCGQ3VYp6mQF2k';
            document.getElementById('fallbackUrl').value = 'https://app.aiprlassist.com/webchat/?p=1047143&ref=1746442093403';
            document.getElementById('bubbleColor').value = '#E67E22';
            document.getElementById('bubbleSize').value = 68;
            document.getElementById('iconUrl').value = 'https://storage.googleapis.com/msgsndr/ecow5j0SgdAz2vzC0C4Q/media/68b225bbb40ac6d4eb8b4ded.png';
            document.getElementById('position').value = 'br';
            document.getElementById('showDelay').value = 3000;
            document.getElementById('openDelay').value = 0;
            document.getElementById('windowWidth').value = 420;
            document.getElementById('windowHeight').value = 650;
            document.getElementById('overlayBg').value = 'rgba(0,0,0,0.45)';
            
            updateLabels();
            updatePreview();
        }

        // Save configuration
        async function saveConfiguration() {
            console.log('üíæ [Control Panel] Starting save configuration...');
            
            if (!currentSiteId) {
                console.error('‚ùå [Control Panel] No currentSiteId set');
                alert('Please select or create a client first');
                return;
            }
            
            console.log('üíæ [Control Panel] Current siteId:', currentSiteId);
            updateClientStatus('üíæ Saving configuration...', 'info');
            
            console.log('üîß [Control Panel] Building configuration object...');
            const config = buildConfigObject();
            console.log('üîß [Control Panel] Configuration object built:', config);
            
            try {
                const payload = {
                    siteId: currentSiteId,
                    clientName: document.getElementById('clientSelect').selectedOptions[0]?.text || currentSiteId,
                    config: config
                };
                
                console.log('üì° [Control Panel] Sending to API:', payload);
                
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('üì° [Control Panel] Save API response status:', response.status);
                const result = await response.json();
                console.log('üì° [Control Panel] Save API response data:', result);
                
                if (response.ok && result.success) {
                    console.log('‚úÖ [Control Panel] Configuration saved successfully!');
                    currentConfig = config;
                    updateClientStatus('‚úÖ Configuration saved successfully!', 'success');
                    generateDeployCode();
                    document.getElementById('deploySuccess').style.display = 'block';
                } else {
                    console.error('‚ùå [Control Panel] Save failed:', result);
                    updateClientStatus(`‚ùå Save failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå [Control Panel] Save error:', error);
                updateClientStatus(`‚ùå Save error: ${error.message}`, 'error');
            }
        }

        // Build configuration object
        function buildConfigObject() {
            return {
                chatUrl: document.getElementById('chatUrl').value,
                fallbackUrl: document.getElementById('fallbackUrl').value,
                webhookUrl: document.getElementById('webhookUrl').value,
                bubble: {
                    position: document.getElementById('position').value,
                    size: parseInt(document.getElementById('bubbleSize').value),
                    bg: document.getElementById('bubbleColor').value,
                    color: "#ffffff",
                    iconUrl: document.getElementById('iconUrl').value,
                    label: document.getElementById('bubbleLabel').value,
                    pulse: featureStates.pulse,
                    zIndex: 2147483000
                },
                triggers: {
                    showBubbleAfterMs: parseInt(document.getElementById('showDelay').value),
                    openAfterMs: parseInt(document.getElementById('openDelay').value),
                    triggerOnScrollPercent: parseInt(document.getElementById('scrollTrigger').value),
                    triggerOnExitIntent: featureStates.exitIntent
                },
                rules: {
                    includePaths: ["*"],
                    excludePaths: [],
                    showOnMobile: true,
                    showOnDesktop: true,
                    appendUTM: featureStates.utmCapture,
                    customParams: document.getElementById('customParams').value.split(',').map(p => p.trim()).filter(Boolean)
                },
                overlay: {
                    bg: document.getElementById('overlayBg').value,
                    closeOnEsc: featureStates.closeOnEsc,
                    windowMode: true,
                    windowWidth: document.getElementById('windowWidth').value + "px",
                    windowHeight: document.getElementById('windowHeight').value + "px",
                    mobileFullscreen: featureStates.mobileFullscreen
                },
                analytics: {
                    console: featureStates.analytics,
                    trackOpens: featureStates.trackOpens,
                    trackPage: featureStates.trackPage,
                    gaId: document.getElementById('gaId').value,
                    fbPixelId: document.getElementById('fbPixelId').value
                },
                webhooks: {
                    enabled: featureStates.webhooksEnabled,
                    endpoint: document.getElementById('webhookEndpoint').value,
                    secret: document.getElementById('webhookSecret').value,
                    events: {
                        chatOpen: featureStates.webhookChatOpen,
                        chatClose: featureStates.webhookChatClose,
                        bubbleShown: featureStates.webhookBubbleShown,
                        pageLoad: featureStates.webhookPageLoad
                    }
                }
            };
        }

        // Generate deployment code
        function generateDeployCode() {
            if (!currentSiteId) return;
            
            const apiBase = document.getElementById('apiBaseUrl').value;
            const widgetVersion = document.getElementById('widgetVersion').value;
            
            const code = `&lt;script src="${apiBase}/${widgetVersion}"&gt;&lt;/script&gt;
&lt;script&gt;
ChatWidget.setup({
  siteId: "${currentSiteId}"
});
&lt;/script&gt;`;
            
            document.getElementById('deployCode').innerHTML = code;
        }

        // Update functions
        function updateSizeLabel() {
            document.getElementById('sizeLabel').textContent = document.getElementById('bubbleSize').value + 'px';
        }

        function updateDelayLabel() {
            document.getElementById('delayLabel').textContent = document.getElementById('showDelay').value + 'ms';
        }

        function updateScrollLabel() {
            const scroll = document.getElementById('scrollTrigger').value;
            document.getElementById('scrollLabel').textContent = scroll == 0 ? 'Disabled' : scroll + '%';
        }

        function updateLabels() {
            updateSizeLabel();
            updateDelayLabel();
            updateScrollLabel();
        }

        function updatePreview() {
            const color = document.getElementById('bubbleColor').value;
            const icon = document.getElementById('iconUrl').value;
            const size = document.getElementById('bubbleSize').value;
            
            const preview = document.getElementById('previewWidget');
            const previewIcon = document.getElementById('previewIcon');
            
            preview.style.background = color;
            preview.style.width = size + 'px';
            preview.style.height = size + 'px';
            previewIcon.src = icon;
        }

        function updateClientStatus(message, type) {
            const statusDiv = document.getElementById('clientStatus');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // UTM Testing
        function testUTMCapture() {
            const params = new URLSearchParams(window.location.search);
            const utmParams = [];
            
            ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                const value = params.get(param);
                if (value) utmParams.push(`${param}: ${value}`);
            });
            
            const customParams = document.getElementById('customParams').value.split(',').map(p => p.trim()).filter(Boolean);
            customParams.forEach(param => {
                const value = params.get(param);
                if (value) utmParams.push(`${param}: ${value}`);
            });
            
            document.getElementById('utmTestResults').innerHTML = `
                <div class="info">
                    <strong>Captured Parameters:</strong><br>
                    ${utmParams.length ? utmParams.join('<br>') : 'No UTM parameters found in current URL'}
                </div>
            `;
            
            updateCurrentUTMs();
        }

        function simulateUTMs() {
            const newUrl = `${window.location.pathname}?utm_source=control_panel&utm_medium=test&utm_campaign=widget_config&utm_term=ai_chat&utm_content=simulation`;
            window.history.pushState({}, '', newUrl);
            updateCurrentUTMs();
            testUTMCapture();
        }

        function updateCurrentUTMs() {
            const params = new URLSearchParams(window.location.search);
            const utms = [];
            ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                const value = params.get(param);
                if (value) utms.push(`${param}=${value}`);
            });
            document.getElementById('currentUTMs').textContent = utms.length ? utms.join(', ') : 'None detected';
        }

        // Webhook Testing
        async function testWebhook() {
            const endpoint = document.getElementById('webhookEndpoint').value;
            if (!endpoint) {
                document.getElementById('webhookTestResults').innerHTML = '<div class="error">‚ùå Please enter a webhook endpoint URL</div>';
                return;
            }
            
            const testPayload = {
                event: 'test_webhook',
                siteId: currentSiteId || 'test-site',
                timestamp: new Date().toISOString(),
                data: {
                    utm_source: 'control_panel',
                    utm_campaign: 'webhook_test',
                    host: window.location.hostname,
                    page: window.location.href,
                    test: true
                }
            };
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });
                
                document.getElementById('webhookTestResults').innerHTML = `
                    <div class="${response.ok ? 'success' : 'error'}">
                        ${response.ok ? '‚úÖ' : '‚ùå'} Webhook test: ${response.status} ${response.statusText}
                    </div>
                `;
            } catch (error) {
                document.getElementById('webhookTestResults').innerHTML = `
                    <div class="error">‚ùå Webhook test failed: ${error.message}</div>
                `;
            }
        }

        // Platform instructions
        function showPlatformInstructions() {
            const platform = document.getElementById('platformSelect').value;
            const instructions = {
                ghl: `
                    <strong>GoHighLevel Instructions:</strong><br>
                    1. Go to Settings ‚Üí Tracking Code<br>
                    2. Paste code in "Footer Tracking Code"<br>
                    3. Save and publish<br>
                    4. Widget appears on all pages automatically
                `,
                webflow: `
                    <strong>Webflow Instructions:</strong><br>
                    1. Go to Project Settings ‚Üí Custom Code<br>
                    2. Paste in "Footer Code" section<br>
                    3. Publish site<br>
                    4. Note: Requires paid Webflow plan
                `,
                wordpress: `
                    <strong>WordPress Instructions:</strong><br>
                    1. Go to Appearance ‚Üí Theme Editor<br>
                    2. Edit footer.php file<br>
                    3. Add code before &lt;/body&gt; tag<br>
                    4. Save changes
                `,
                shopify: `
                    <strong>Shopify Instructions:</strong><br>
                    1. Go to Online Store ‚Üí Themes<br>
                    2. Actions ‚Üí Edit Code<br>
                    3. Edit theme.liquid file<br>
                    4. Add before &lt;/body&gt; tag<br>
                    5. Save
                `,
                custom: `
                    <strong>Custom HTML Instructions:</strong><br>
                    1. Copy the deployment code above<br>
                    2. Paste before the &lt;/body&gt; tag<br>
                    3. Save and upload your website<br>
                    4. Widget will appear automatically
                `
            };
            
            document.getElementById('platformInstructions').innerHTML = instructions[platform] || '';
        }

        // Copy deployment code
        function copyDeployCode() {
            const codeElement = document.getElementById('deployCode');
            const text = codeElement.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Deployment code copied to clipboard!');
            });
        }

        // Test live widget
        function testLiveWidget() {
            if (!currentSiteId) {
                alert('Please select a client first');
                return;
            }
            
            // Remove existing test widget
            const existing = document.getElementById('testWidgetScript');
            if (existing) existing.remove();
            
            // Load the database widget
            const script = document.createElement('script');
            script.src = 'https://dynamiccode-ochre.vercel.app/chat-widget-db.js';
            script.id = 'testWidgetScript';
            script.onload = () => {
                if (window.ChatWidget && window.ChatWidget.setup) {
                    window.ChatWidget.setup({
                        siteId: currentSiteId,
                        analytics: true,
                        apiBase: window.location.origin
                    });
                    alert('üß™ Live widget loaded! Check bottom-right corner.');
                }
            };
            document.head.appendChild(script);
        }

        function testPreviewClick() {
            alert('üí¨ This is the preview widget!\n\nAfter saving configuration, the real widget will work exactly like this.');
        }

        // Export/Import
        function exportConfiguration() {
            if (!currentConfig || !currentSiteId) {
                alert('Please load a client configuration first');
                return;
            }
            
            const exportData = {
                siteId: currentSiteId,
                config: currentConfig,
                exported: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSiteId}-config.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importConfiguration() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.config && data.siteId) {
                                populateForm(data.config);
                                alert(`‚úÖ Configuration imported for ${data.siteId}`);
                            } else {
                                alert('‚ùå Invalid configuration file');
                            }
                        } catch (error) {
                            alert(`‚ùå Error reading file: ${error.message}`);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéõÔ∏è [Control Panel] Page loaded, initializing...');
            
            updateCurrentUTMs();
            updatePreview();
            updateLabels();
            
            console.log('üéõÔ∏è [Control Panel] Basic initialization complete');
            
            // Auto-load default client
            setTimeout(() => {
                console.log('üéõÔ∏è [Control Panel] Auto-loading default client...');
                document.getElementById('clientSelect').value = 'aiprlassist-default';
                loadClient();
            }, 1000);
        });

        // Global save function (accessible from anywhere)
        window.saveConfig = saveConfiguration;
    </script>

    <!-- Fixed Save Button -->
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 1001;">
        <button onclick="saveConfig()" style="background: #28a745; padding: 15px 25px; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            üíæ SAVE CONFIGURATION
        </button>
    </div>
</body>
</html>

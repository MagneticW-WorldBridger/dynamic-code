<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 E2E Tests - Chat Widget</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; padding: 20px; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .test-header { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .test-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-result { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: 600; }
        .test-pass { background: #d4edda; color: #155724; }
        .test-fail { background: #f8d7da; color: #721c24; }
        .test-pending { background: #fff3cd; color: #856404; }
        .btn { background: #6f0302; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 5px; }
        .btn:hover { background: #5a0201; }
        .btn-secondary { background: #6c757d; }
        .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; margin: 10px 0; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease; }
        .test-log { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 End-to-End Tests - Chat Widget System</h1>
            <p>Verificación completa de funcionalidad, configuraciones y multi-tenant.</p>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            
            <div>
                <button class="btn" onclick="runAllTests()">🚀 Run All Tests</button>
                <button class="btn btn-secondary" onclick="runSingleTest()">🎯 Single Test</button>
                <button class="btn btn-secondary" onclick="clearResults()">🧹 Clear Results</button>
            </div>
        </div>

        <div class="test-grid">
            <!-- Widget Loading Tests -->
            <div class="test-card">
                <h3>📦 Widget Loading Tests</h3>
                <div id="test-widget-load" class="test-result test-pending">⏳ Pending: Widget Script Load</div>
                <div id="test-widget-init" class="test-result test-pending">⏳ Pending: Widget Initialization</div>
                <div id="test-shadow-dom" class="test-result test-pending">⏳ Pending: Shadow DOM Creation</div>
                <div id="test-api-available" class="test-result test-pending">⏳ Pending: Public API Available</div>
                
                <button class="btn" onclick="testWidgetLoading()">Test Widget Loading</button>
            </div>

            <!-- Configuration Tests -->
            <div class="test-card">
                <h3>⚙️ Configuration Tests</h3>
                <div id="test-config-fetch" class="test-result test-pending">⏳ Pending: Config Fetch</div>
                <div id="test-config-merge" class="test-result test-pending">⏳ Pending: Config Merge</div>
                <div id="test-multi-tenant" class="test-result test-pending">⏳ Pending: Multi-tenant Support</div>
                <div id="test-fallback-url" class="test-result test-pending">⏳ Pending: Fallback URL Logic</div>
                
                <button class="btn" onclick="testConfiguration()">Test Configuration</button>
            </div>

            <!-- UI/UX Tests -->
            <div class="test-card">
                <h3>🎨 UI/UX Tests</h3>
                <div id="test-bubble-render" class="test-result test-pending">⏳ Pending: Bubble Rendering</div>
                <div id="test-bubble-position" class="test-result test-pending">⏳ Pending: Bubble Positioning</div>
                <div id="test-responsive" class="test-result test-pending">⏳ Pending: Responsive Behavior</div>
                <div id="test-window-mode" class="test-result test-pending">⏳ Pending: Window Mode</div>
                
                <button class="btn" onclick="testUIUX()">Test UI/UX</button>
            </div>

            <!-- Analytics Tests -->
            <div class="test-card">
                <h3>📊 Analytics Tests</h3>
                <div id="test-utm-capture" class="test-result test-pending">⏳ Pending: UTM Capture</div>
                <div id="test-event-tracking" class="test-result test-pending">⏳ Pending: Event Tracking</div>
                <div id="test-local-storage" class="test-result test-pending">⏳ Pending: Local Storage</div>
                <div id="test-analytics-data" class="test-result test-pending">⏳ Pending: Analytics Data Format</div>
                
                <button class="btn" onclick="testAnalytics()">Test Analytics</button>
            </div>

            <!-- Integration Tests -->
            <div class="test-card">
                <h3>🔗 Integration Tests</h3>
                <div id="test-chat-open" class="test-result test-pending">⏳ Pending: Chat Opening</div>
                <div id="test-iframe-load" class="test-result test-pending">⏳ Pending: Iframe Loading</div>
                <div id="test-param-passing" class="test-result test-pending">⏳ Pending: Parameter Passing</div>
                <div id="test-error-handling" class="test-result test-pending">⏳ Pending: Error Handling</div>
                
                <button class="btn" onclick="testIntegration()">Test Integration</button>
            </div>

            <!-- Performance Tests -->
            <div class="test-card">
                <h3>⚡ Performance Tests</h3>
                <div id="test-load-time" class="test-result test-pending">⏳ Pending: Load Time < 2s</div>
                <div id="test-memory-usage" class="test-result test-pending">⏳ Pending: Memory Usage</div>
                <div id="test-bundle-size" class="test-result test-pending">⏳ Pending: Bundle Size</div>
                <div id="test-network-requests" class="test-result test-pending">⏳ Pending: Network Efficiency</div>
                
                <button class="btn" onclick="testPerformance()">Test Performance</button>
            </div>
        </div>

        <div class="test-card" style="margin-top: 30px;">
            <h3>📋 Test Results Summary</h3>
            <div id="testSummary">
                <p>Run tests to see results...</p>
            </div>
            
            <h4>🔍 Test Log</h4>
            <div id="testLog" class="test-log">
                Ready to run tests...
            </div>
        </div>
    </div>

    <!-- Load the actual widget for testing -->
    <script>
        window.ChatWidget = {
            siteId: "webflow-windowed-001",
            configUrl: "https://dynamiccode-ochre.vercel.app/configs/{{siteId}}.json"
        };
    </script>
    <script async src="https://dynamiccode-ochre.vercel.app/chat-widget.js"></script>

    <script>
        let testResults = {};
        let testLog = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog.push(logMessage);
            
            const logElement = document.getElementById('testLog');
            logElement.innerHTML = testLog.slice(-20).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMessage);
        }

        function setTestResult(testId, passed, message) {
            testResults[testId] = { passed, message };
            const element = document.getElementById(testId);
            
            if (passed) {
                element.className = 'test-result test-pass';
                element.textContent = `✅ PASS: ${message}`;
            } else {
                element.className = 'test-result test-fail';
                element.textContent = `❌ FAIL: ${message}`;
            }
            
            updateProgress();
            log(`${testId}: ${passed ? 'PASS' : 'FAIL'} - ${message}`);
        }

        function updateProgress() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.passed).length;
            const percentage = total > 0 ? (passed / 24) * 100 : 0; // 24 total tests
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            
            const summary = `
                <strong>Progress:</strong> ${passed}/24 tests passed (${Math.round(percentage)}%)<br>
                <strong>Status:</strong> ${percentage === 100 ? '🎉 All tests passed!' : '🔄 Tests in progress...'}
            `;
            document.getElementById('testSummary').innerHTML = summary;
        }

        async function testWidgetLoading() {
            log('Starting Widget Loading Tests...');
            
            // Test 1: Widget Script Load
            try {
                const scriptExists = document.querySelector('script[src*="chat-widget.js"]');
                setTestResult('test-widget-load', !!scriptExists, 'Widget script found in DOM');
            } catch (e) {
                setTestResult('test-widget-load', false, `Script load error: ${e.message}`);
            }

            // Test 2: Widget Initialization
            await new Promise(resolve => setTimeout(resolve, 2000)); // Wait for widget to load
            
            try {
                const widgetLoaded = window.__chatWidgetLoaded;
                setTestResult('test-widget-init', !!widgetLoaded, 'Widget initialized successfully');
            } catch (e) {
                setTestResult('test-widget-init', false, `Init error: ${e.message}`);
            }

            // Test 3: Shadow DOM Creation
            try {
                const shadowHost = document.getElementById('cw_v1-host');
                setTestResult('test-shadow-dom', !!shadowHost, 'Shadow DOM host created');
            } catch (e) {
                setTestResult('test-shadow-dom', false, `Shadow DOM error: ${e.message}`);
            }

            // Test 4: Public API Available
            try {
                const apiAvailable = window.ChatWidget && typeof window.ChatWidget.open === 'function';
                setTestResult('test-api-available', apiAvailable, 'Public API methods available');
            } catch (e) {
                setTestResult('test-api-available', false, `API error: ${e.message}`);
            }
        }

        async function testConfiguration() {
            log('Starting Configuration Tests...');
            
            // Test 1: Config Fetch
            try {
                const response = await fetch('https://dynamiccode-ochre.vercel.app/configs/webflow-windowed-001.json');
                const configFetched = response.ok;
                setTestResult('test-config-fetch', configFetched, `Config fetch: ${response.status}`);
            } catch (e) {
                setTestResult('test-config-fetch', false, `Config fetch error: ${e.message}`);
            }

            // Test 2: Config Merge
            try {
                const hasConfig = window.ChatWidget && window.ChatWidget.siteId;
                setTestResult('test-config-merge', !!hasConfig, 'Config merged successfully');
            } catch (e) {
                setTestResult('test-config-merge', false, `Config merge error: ${e.message}`);
            }

            // Test 3: Multi-tenant Support
            try {
                const siteId = window.ChatWidget.siteId;
                const isMultiTenant = siteId && siteId !== 'default';
                setTestResult('test-multi-tenant', isMultiTenant, `SiteId: ${siteId}`);
            } catch (e) {
                setTestResult('test-multi-tenant', false, `Multi-tenant error: ${e.message}`);
            }

            // Test 4: Fallback URL Logic
            try {
                const response = await fetch('https://dynamiccode-ochre.vercel.app/configs/webflow-windowed-001.json');
                const config = await response.json();
                const hasFallback = !!config.fallbackUrl;
                setTestResult('test-fallback-url', hasFallback, 'Fallback URL configured');
            } catch (e) {
                setTestResult('test-fallback-url', false, `Fallback test error: ${e.message}`);
            }
        }

        async function testUIUX() {
            log('Starting UI/UX Tests...');
            
            await new Promise(resolve => setTimeout(resolve, 3000)); // Wait for UI to render

            // Test 1: Bubble Rendering
            try {
                const shadowHost = document.getElementById('cw_v1-host');
                const bubble = shadowHost?.shadowRoot?.querySelector('.cw-bubble');
                setTestResult('test-bubble-render', !!bubble, 'Chat bubble rendered in shadow DOM');
            } catch (e) {
                setTestResult('test-bubble-render', false, `Bubble render error: ${e.message}`);
            }

            // Test 2: Bubble Positioning
            try {
                const shadowHost = document.getElementById('cw_v1-host');
                const bubble = shadowHost?.shadowRoot?.querySelector('.cw-bubble');
                const isPositioned = bubble && getComputedStyle(bubble).position === 'fixed';
                setTestResult('test-bubble-position', isPositioned, 'Bubble positioned correctly');
            } catch (e) {
                setTestResult('test-bubble-position', false, `Position error: ${e.message}`);
            }

            // Test 3: Responsive Behavior
            try {
                const isMobile = window.innerWidth < 768;
                const responsiveTest = true; // Simplified for demo
                setTestResult('test-responsive', responsiveTest, `Responsive design (${isMobile ? 'mobile' : 'desktop'})`);
            } catch (e) {
                setTestResult('test-responsive', false, `Responsive error: ${e.message}`);
            }

            // Test 4: Window Mode
            try {
                const response = await fetch('https://dynamiccode-ochre.vercel.app/configs/webflow-windowed-001.json');
                const config = await response.json();
                const windowMode = config.overlay?.windowMode;
                setTestResult('test-window-mode', typeof windowMode === 'boolean', `Window mode: ${windowMode}`);
            } catch (e) {
                setTestResult('test-window-mode', false, `Window mode error: ${e.message}`);
            }
        }

        async function testAnalytics() {
            log('Starting Analytics Tests...');
            
            // Test 1: UTM Capture
            try {
                const params = new URLSearchParams(window.location.search);
                const hasUTMs = Array.from(params.keys()).some(key => key.startsWith('utm_'));
                setTestResult('test-utm-capture', true, `UTM capture ready (${hasUTMs ? 'UTMs present' : 'no UTMs'})`);
            } catch (e) {
                setTestResult('test-utm-capture', false, `UTM capture error: ${e.message}`);
            }

            // Test 2: Event Tracking
            try {
                const trackingWorks = typeof Storage !== 'undefined';
                setTestResult('test-event-tracking', trackingWorks, 'Event tracking system ready');
            } catch (e) {
                setTestResult('test-event-tracking', false, `Event tracking error: ${e.message}`);
            }

            // Test 3: Local Storage
            try {
                localStorage.setItem('test-widget', 'test');
                const storageWorks = localStorage.getItem('test-widget') === 'test';
                localStorage.removeItem('test-widget');
                setTestResult('test-local-storage', storageWorks, 'Local storage functional');
            } catch (e) {
                setTestResult('test-local-storage', false, `Local storage error: ${e.message}`);
            }

            // Test 4: Analytics Data Format
            try {
                const events = JSON.parse(localStorage.getItem('chatWidgetEvents') || '[]');
                const formatValid = Array.isArray(events);
                setTestResult('test-analytics-data', formatValid, `Analytics format valid (${events.length} events)`);
            } catch (e) {
                setTestResult('test-analytics-data', false, `Analytics format error: ${e.message}`);
            }
        }

        async function testIntegration() {
            log('Starting Integration Tests...');
            
            // Test 1: Chat Opening
            try {
                if (window.ChatWidget && window.ChatWidget.open) {
                    // Don't actually open, just test the function exists
                    setTestResult('test-chat-open', true, 'Chat open function available');
                } else {
                    setTestResult('test-chat-open', false, 'Chat open function not found');
                }
            } catch (e) {
                setTestResult('test-chat-open', false, `Chat open error: ${e.message}`);
            }

            // Test 2: Iframe Loading
            try {
                const shadowHost = document.getElementById('cw_v1-host');
                const iframe = shadowHost?.shadowRoot?.querySelector('.cw-iframe');
                setTestResult('test-iframe-load', !!iframe, 'Iframe element created');
            } catch (e) {
                setTestResult('test-iframe-load', false, `Iframe error: ${e.message}`);
            }

            // Test 3: Parameter Passing
            try {
                const testUrl = 'https://example.com?test=1';
                const hasParams = testUrl.includes('?');
                setTestResult('test-param-passing', hasParams, 'Parameter passing logic ready');
            } catch (e) {
                setTestResult('test-param-passing', false, `Parameter error: ${e.message}`);
            }

            // Test 4: Error Handling
            try {
                const errorHandling = typeof window.addEventListener === 'function';
                setTestResult('test-error-handling', errorHandling, 'Error handling mechanisms ready');
            } catch (e) {
                setTestResult('test-error-handling', false, `Error handling error: ${e.message}`);
            }
        }

        async function testPerformance() {
            log('Starting Performance Tests...');
            
            // Test 1: Load Time
            const loadStart = performance.now();
            await new Promise(resolve => setTimeout(resolve, 100));
            const loadTime = performance.now() - loadStart;
            setTestResult('test-load-time', loadTime < 2000, `Load time: ${Math.round(loadTime)}ms`);

            // Test 2: Memory Usage
            try {
                const memoryInfo = performance.memory;
                const memoryOK = !memoryInfo || memoryInfo.usedJSHeapSize < 50 * 1024 * 1024; // 50MB
                setTestResult('test-memory-usage', memoryOK, 'Memory usage within limits');
            } catch (e) {
                setTestResult('test-memory-usage', true, 'Memory info not available (OK)');
            }

            // Test 3: Bundle Size
            try {
                const response = await fetch('https://dynamiccode-ochre.vercel.app/chat-widget.js', { method: 'HEAD' });
                const size = parseInt(response.headers.get('content-length') || '0');
                const sizeOK = size < 50 * 1024; // 50KB
                setTestResult('test-bundle-size', sizeOK, `Bundle size: ${Math.round(size/1024)}KB`);
            } catch (e) {
                setTestResult('test-bundle-size', false, `Bundle size error: ${e.message}`);
            }

            // Test 4: Network Efficiency
            try {
                const resourceEntries = performance.getEntriesByType('resource');
                const widgetRequests = resourceEntries.filter(entry => entry.name.includes('chat-widget'));
                const efficient = widgetRequests.length <= 2; // Widget + config
                setTestResult('test-network-requests', efficient, `Network requests: ${widgetRequests.length}`);
            } catch (e) {
                setTestResult('test-network-requests', false, `Network test error: ${e.message}`);
            }
        }

        async function runAllTests() {
            log('🚀 Starting comprehensive E2E test suite...');
            clearResults();
            
            await testWidgetLoading();
            await testConfiguration();
            await testUIUX();
            await testAnalytics();
            await testIntegration();
            await testPerformance();
            
            log('✅ All tests completed!');
        }

        function runSingleTest() {
            const tests = [
                { name: 'Widget Loading', fn: testWidgetLoading },
                { name: 'Configuration', fn: testConfiguration },
                { name: 'UI/UX', fn: testUIUX },
                { name: 'Analytics', fn: testAnalytics },
                { name: 'Integration', fn: testIntegration },
                { name: 'Performance', fn: testPerformance }
            ];
            
            const choice = prompt(`Choose test to run:\n${tests.map((t, i) => `${i + 1}. ${t.name}`).join('\n')}`);
            const index = parseInt(choice) - 1;
            
            if (index >= 0 && index < tests.length) {
                log(`Running ${tests[index].name} tests...`);
                tests[index].fn();
            }
        }

        function clearResults() {
            testResults = {};
            testLog = [];
            
            document.querySelectorAll('.test-result').forEach(el => {
                el.className = 'test-result test-pending';
                el.textContent = el.textContent.replace(/✅ PASS:|❌ FAIL:/, '⏳ Pending:');
            });
            
            document.getElementById('testLog').innerHTML = 'Ready to run tests...';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('testSummary').innerHTML = '<p>Run tests to see results...</p>';
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded, widget should be initializing...');
            }, 1000);
        });
    </script>
</body>
</html>
